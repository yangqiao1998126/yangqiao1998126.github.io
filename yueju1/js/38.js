(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[38],{37291:e=>{"use strict";function t(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function r(e,t){for(var r,n="",s=0,i=-1,o=0,a=0;a<=e.length;++a){if(a<e.length)r=e.charCodeAt(a);else{if(47===r)break;r=47}if(47===r){if(i===a-1||1===o);else if(i!==a-1&&2===o){if(n.length<2||2!==s||46!==n.charCodeAt(n.length-1)||46!==n.charCodeAt(n.length-2))if(n.length>2){var l=n.lastIndexOf("/");if(l!==n.length-1){-1===l?(n="",s=0):s=(n=n.slice(0,l)).length-1-n.lastIndexOf("/"),i=a,o=0;continue}}else if(2===n.length||1===n.length){n="",s=0,i=a,o=0;continue}t&&(n.length>0?n+="/..":n="..",s=2)}else n.length>0?n+="/"+e.slice(i+1,a):n=e.slice(i+1,a),s=a-i-1;i=a,o=0}else 46===r&&-1!==o?++o:o=-1}return n}var n={resolve:function(){for(var e,n="",s=!1,i=arguments.length-1;i>=-1&&!s;i--){var o;i>=0?o=arguments[i]:(void 0===e&&(e=process.cwd()),o=e),t(o),0!==o.length&&(n=o+"/"+n,s=47===o.charCodeAt(0))}return n=r(n,!s),s?n.length>0?"/"+n:"/":n.length>0?n:"."},normalize:function(e){if(t(e),0===e.length)return".";var n=47===e.charCodeAt(0),s=47===e.charCodeAt(e.length-1);return 0!==(e=r(e,!n)).length||n||(e="."),e.length>0&&s&&(e+="/"),n?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,r=0;r<arguments.length;++r){var s=arguments[r];t(s),s.length>0&&(void 0===e?e=s:e+="/"+s)}return void 0===e?".":n.normalize(e)},relative:function(e,r){if(t(e),t(r),e===r)return"";if((e=n.resolve(e))===(r=n.resolve(r)))return"";for(var s=1;s<e.length&&47===e.charCodeAt(s);++s);for(var i=e.length,o=i-s,a=1;a<r.length&&47===r.charCodeAt(a);++a);for(var l=r.length-a,c=o<l?o:l,h=-1,d=0;d<=c;++d){if(d===c){if(l>c){if(47===r.charCodeAt(a+d))return r.slice(a+d+1);if(0===d)return r.slice(a+d)}else o>c&&(47===e.charCodeAt(s+d)?h=d:0===d&&(h=0));break}var u=e.charCodeAt(s+d);if(u!==r.charCodeAt(a+d))break;47===u&&(h=d)}var p="";for(d=s+h+1;d<=i;++d)d!==i&&47!==e.charCodeAt(d)||(0===p.length?p+="..":p+="/..");return p.length>0?p+r.slice(a+h):(a+=h,47===r.charCodeAt(a)&&++a,r.slice(a))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var r=e.charCodeAt(0),n=47===r,s=-1,i=!0,o=e.length-1;o>=1;--o)if(47===(r=e.charCodeAt(o))){if(!i){s=o;break}}else i=!1;return-1===s?n?"/":".":n&&1===s?"//":e.slice(0,s)},basename:function(e,r){if(void 0!==r&&"string"!=typeof r)throw new TypeError('"ext" argument must be a string');t(e);var n,s=0,i=-1,o=!0;if(void 0!==r&&r.length>0&&r.length<=e.length){if(r.length===e.length&&r===e)return"";var a=r.length-1,l=-1;for(n=e.length-1;n>=0;--n){var c=e.charCodeAt(n);if(47===c){if(!o){s=n+1;break}}else-1===l&&(o=!1,l=n+1),a>=0&&(c===r.charCodeAt(a)?-1==--a&&(i=n):(a=-1,i=l))}return s===i?i=l:-1===i&&(i=e.length),e.slice(s,i)}for(n=e.length-1;n>=0;--n)if(47===e.charCodeAt(n)){if(!o){s=n+1;break}}else-1===i&&(o=!1,i=n+1);return-1===i?"":e.slice(s,i)},extname:function(e){t(e);for(var r=-1,n=0,s=-1,i=!0,o=0,a=e.length-1;a>=0;--a){var l=e.charCodeAt(a);if(47!==l)-1===s&&(i=!1,s=a+1),46===l?-1===r?r=a:1!==o&&(o=1):-1!==r&&(o=-1);else if(!i){n=a+1;break}}return-1===r||-1===s||0===o||1===o&&r===s-1&&r===n+1?"":e.slice(r,s)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var r=t.dir||t.root,n=t.base||(t.name||"")+(t.ext||"");return r?r===t.root?r+n:r+e+n:n}("/",e)},parse:function(e){t(e);var r={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return r;var n,s=e.charCodeAt(0),i=47===s;i?(r.root="/",n=1):n=0;for(var o=-1,a=0,l=-1,c=!0,h=e.length-1,d=0;h>=n;--h)if(47!==(s=e.charCodeAt(h)))-1===l&&(c=!1,l=h+1),46===s?-1===o?o=h:1!==d&&(d=1):-1!==o&&(d=-1);else if(!c){a=h+1;break}return-1===o||-1===l||0===d||1===d&&o===l-1&&o===a+1?-1!==l&&(r.base=r.name=0===a&&i?e.slice(1,l):e.slice(a,l)):(0===a&&i?(r.name=e.slice(1,o),r.base=e.slice(1,l)):(r.name=e.slice(a,o),r.base=e.slice(a,l)),r.ext=e.slice(o,l)),a>0?r.dir=e.slice(0,a-1):i&&(r.dir="/"),r},sep:"/",delimiter:":",win32:null,posix:null};n.posix=n,e.exports=n},91283:(e,t,r)=>{"use strict";r.d(t,{Jk:()=>n,br:()=>s,yX:()=>i,tE:()=>o,ig:()=>a});const n=0,s=1,i=2,o=3,a=4},41038:(e,t,r)=>{"use strict";r.d(t,{I:()=>TilesRenderer});var n=r(37291);function s(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const r=t.pathname.split("/").pop(),n=r.lastIndexOf(".");if(-1===n||n===r.length-1)return null;return r.substring(n+1)}class LRUCache{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const r=this.itemSet;if(r.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,s=this.itemList,i=this.callbacks;return s.push(e),n.add(e),r.set(e,Date.now()),i.set(e,t),!0}remove(e){const t=this.usedSet,r=this.itemSet,n=this.itemList,s=this.callbacks;if(r.has(e)){s.get(e)(e);const i=n.indexOf(e);return n.splice(i,1),t.delete(e),r.delete(e),s.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,r=this.usedSet;t.has(e)&&!r.has(e)&&(t.set(e,Date.now()),r.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,r=this.itemList,n=this.itemSet,s=this.usedSet,i=this.callbacks,o=r.length-s.size,a=r.length-t,l=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&o>0){r.sort(((e,t)=>{const r=s.has(e),n=s.has(t);return r&&n?0:r||n?r?1:-1:l(t)-l(e)}));const c=Math.min(a,o),h=Math.max(t*e,c*e);let d=Math.min(h,o);d=Math.ceil(d);const u=r.splice(0,d);for(let e=0,t=u.length;e<t;e++){const t=u[e];i.get(t)(t),n.delete(t),i.delete(t)}}}scheduleUnload(e=!0){var t;this.scheduled||(this.scheduled=!0,t=()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()},Promise.resolve().then(t))}}var i=r(80122),o=r(91283);function a(e){return e===o.tE||e===o.ig}function l(e,t){return e.__lastFrameVisited===t&&e.__used}function c(e,t){e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)}function h(e,t,r){if(c(e,t),e.__used=!0,r.markUsed(e),e.__contentEmpty){const n=e.children;for(let e=0,s=n.length;e<s;e++)h(n[e],t,r)}}function d(e,t,r){if(e.__contentEmpty&&(!e.__externalTileSet||a(e.__loadingState))){const n=e.children;for(let e=0,s=n.length;e<s;e++){const s=n[e];s.__depthFromRenderedParent=t,d(s,t,r)}}else r.requestTileContents(e)}function u(e,t=null,r=null,n=null,s=0){if(t&&t(e,n,s))return void(r&&r(e,n,s));const i=e.children;for(let n=0,o=i.length;n<o;n++)u(i[n],t,r,e,s+1);r&&r(e,n,s)}function p(e,t){const r=t.stats,n=t.frameCount,s=t.errorTarget,i=t.maxDepth,o=t.loadSiblings,a=t.lruCache,l=t.stopAtEmptyTiles;c(e,n);if(!1===t.tileInView(e))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,r.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){t.calculateError(e);if(e.__error<=s)return!0;if(t.maxDepth>0&&e.__depth+1>=i)return!0}let d=!1;const u=e.children;for(let e=0,r=u.length;e<r;e++){const r=p(u[e],t);d=d||r}if(d&&o)for(let e=0,t=u.length;e<t;e++){h(u[e],n,a)}return!0}function f(e,t){const r=t.stats,n=t.frameCount;if(!l(e,n))return;r.used++;const s=e.children;let i=!1;for(let e=0,t=s.length;e<t;e++){const t=s[e];i=i||l(t,n)}if(i){let r=!1,i=!0;for(let e=0,c=s.length;e<c;e++){const c=s[e];if(f(c,t),r=r||c.__wasSetVisible||c.__childrenWereVisible,l(c,n)){const e=c.__allChildrenLoaded||!c.__contentEmpty&&a(c.__loadingState)||c.__externalTileSet&&c.__loadingState===o.ig;i=i&&e}}e.__childrenWereVisible=r,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function g(e,t){const r=t.stats,n=t.frameCount;if(!l(e,n))return;const s=e.parent,i=s?s.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=i;const c=t.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(e.__loadingState===o.tE?(e.__inFrustum&&(e.__visible=!0,r.visible++),e.__active=!0,r.active++):c.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.requestTileContents(e));const h=(t.errorTarget+1)*t.errorThreshold,u=e.__error<=h,p=u||"ADD"===e.refine,f=!e.__contentEmpty,_=f||e.__externalTileSet,m=a(e.__loadingState)&&_,b=e.__childrenWereVisible,T=e.children;let w=e.__allChildrenLoaded;if(p&&f&&e.__depthFromRenderedParent++,p&&!m&&!c.isFull()&&_&&t.requestTileContents(e),(u&&!w&&!b&&m||"ADD"===e.refine&&m)&&(e.__inFrustum&&(e.__visible=!0,r.visible++),e.__active=!0,r.active++),"ADD"!==e.refine&&u&&!w&&m)for(let r=0,s=T.length;r<s;r++){const s=T[r];l(s,n)&&!c.isFull()&&(s.__depthFromRenderedParent=e.__depthFromRenderedParent+1,d(s,s.__depthFromRenderedParent,t))}else for(let e=0,r=T.length;e<r;e++){const r=T[e];l(r,n)&&g(r,t)}}function _(e,t){const r=l(e,t.frameCount);if(r||e.__usedLastFrame){let n=!1,s=!1;r&&(n=e.__active,s=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||e.__loadingState!==o.tE||(e.__wasSetActive!==n&&t.setTileActive(e,n),e.__wasSetVisible!==s&&t.setTileVisible(e,s)),e.__wasSetActive=n,e.__wasSetVisible=s,e.__usedLastFrame=r;const i=e.children;for(let e=0,r=i.length;e<r;e++){_(i[e],t)}}}const m=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,b=e=>1/(e.__depthFromRenderedParent+1);function T(e){return(new TextDecoder).decode(e)}class FeatureTable{constructor(e,t,r,n){this.buffer=e,this.binOffset=t+r,this.binLength=n;let s=null;if(0!==r){const n=new Uint8Array(e,t,r);s=JSON.parse(T(n))}else s={};this.header=s}getKeys(){return Object.keys(this.header)}getData(e,t,r=null,n=null){const s=this.header;if(!(e in s))return null;const i=s[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:s,binOffset:o,binLength:a}=this,l=i.byteOffset||0,c=i.type||n,h=i.componentType||r;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");let d,u;switch(c){case"SCALAR":d=1;break;case"VEC2":d=2;break;case"VEC3":d=3;break;case"VEC4":d=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}const p=o+l,f=t*d;switch(h){case"BYTE":u=new Int8Array(s,p,f);break;case"UNSIGNED_BYTE":u=new Uint8Array(s,p,f);break;case"SHORT":u=new Int16Array(s,p,f);break;case"UNSIGNED_SHORT":u=new Uint16Array(s,p,f);break;case"INT":u=new Int32Array(s,p,f);break;case"UNSIGNED_INT":u=new Uint32Array(s,p,f);break;case"FLOAT":u=new Float32Array(s,p,f);break;case"DOUBLE":u=new Float64Array(s,p,f);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(p+f*u.BYTES_PER_ELEMENT>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return i}}class BatchTable extends FeatureTable{constructor(e,t,r,n,s){super(e,r,n,s),this.batchSize=t}getData(e,t=null,r=null){return super.getData(e,this.batchSize,r,t)}}class LoaderBase{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){}}class B3DMLoaderBase extends LoaderBase{constructor(){super()}parse(e){const t=new DataView(e),r=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("b3dm"===r);const n=t.getUint32(4,!0);console.assert(1===n);const s=t.getUint32(8,!0);console.assert(s===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new FeatureTable(c,0,i,o),d=28+i+o,u=e.slice(d,d+a+l),p=new BatchTable(u,h.getData("BATCH_LENGTH"),0,a,l),f=d+a+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,f,s-f)}}}var w=r(2212),x=r(17047);class B3DMLoader extends B3DMLoaderBase{constructor(e=w.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),r=t.glbBytes.slice().buffer;return new Promise(((e,n)=>{const s=this.manager,i=this.fetchOptions,o=s.getHandler("path.gltf")||new x.GLTFLoader(s);"include"===i.credentials&&"cors"===i.mode&&o.setCrossOrigin("use-credentials"),"credentials"in i&&o.setWithCredentials("include"===i.credentials),i.headers&&o.setRequestHeader(i.headers);let a=this.workingPath;/[\\/]$/.test(a)||(a+="/"),o.parse(r,a,(r=>{const{batchTable:n,featureTable:s}=t,{scene:i}=r,o=s.getData("RTC_CENTER");o&&(i.position.x+=o[0],i.position.y+=o[1],i.position.z+=o[2]),r.batchTable=n,r.featureTable=s,i.batchTable=n,i.featureTable=s,e(r)}),n)}))}}class PNTSLoaderBase extends LoaderBase{constructor(){super()}parse(e){const t=new DataView(e),r=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("pnts"===r);const n=t.getUint32(4,!0);console.assert(1===n);const s=t.getUint32(8,!0);console.assert(s===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new FeatureTable(c,0,i,o),d=28+i+o,u=e.slice(d,d+a+l),p=new BatchTable(u,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,a,l);return Promise.resolve({version:n,featureTable:h,batchTable:p})}}class PNTSLoader extends PNTSLoaderBase{constructor(e=w.DefaultLoadingManager){super(),this.manager=e}parse(e){return super.parse(e).then((e=>{const{featureTable:t}=e,r=t.getData("POINTS_LENGTH"),n=t.getData("POSITION",r,"FLOAT","VEC3"),s=t.getData("RGB",r,"UNSIGNED_BYTE","VEC3");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const i=new w.BufferGeometry;i.setAttribute("position",new w.BufferAttribute(n,3,!1));const o=new w.PointsMaterial;o.size=2,o.sizeAttenuation=!1,null!==s&&(i.setAttribute("color",new w.BufferAttribute(s,3,!0)),o.vertexColors=!0);const a=new w.Points(i,o);e.scene=a,e.scene.featureTable=t;const l=t.getData("RTC_CENTER");return l&&(e.scene.position.x+=l[0],e.scene.position.y+=l[1],e.scene.position.z+=l[2]),e}))}}class I3DMLoaderBase extends LoaderBase{constructor(){super()}parse(e){const t=new DataView(e),r=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("i3dm"===r);const n=t.getUint32(4,!0);console.assert(1===n);const s=t.getUint32(8,!0);console.assert(s===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+o),d=new FeatureTable(h,0,i,o),u=32+i+o,p=e.slice(u,u+a+l),f=new BatchTable(p,d.getData("INSTANCES_LENGTH"),0,a,l),g=u+a+l,_=new Uint8Array(e,g,s-g);let m=null,b=null;if(c)m=_,b=Promise.resolve();else{const e=this.resolveExternalURL(T(_));b=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{m=new Uint8Array(e)}))}return b.then((()=>({version:n,featureTable:d,batchTable:f,glbBytes:m})))}}const y=new w.Vector3,C=new w.Vector3,S=new w.Vector3,L=new w.Vector3,v=new w.Quaternion,U=new w.Vector3,A=new w.Matrix4;class I3DMLoader extends I3DMLoaderBase{constructor(e=w.DefaultLoadingManager){super(),this.manager=e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:r}=e,n=e.glbBytes.slice().buffer;return new Promise(((e,s)=>{const i=this.fetchOptions,o=this.manager,a=o.getHandler("path.gltf")||new x.GLTFLoader(o);"include"===i.credentials&&"cors"===i.mode&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials("include"===i.credentials),i.headers&&a.setRequestHeader(i.headers);let l=this.workingPath;/[\\/]$/.test(l)||(l+="/"),a.parse(n,l,(n=>{const s=t.getData("INSTANCES_LENGTH"),i=t.getData("POSITION",s,"FLOAT","VEC3"),o=t.getData("NORMAL_UP",s,"FLOAT","VEC3"),a=t.getData("NORMAL_RIGHT",s,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",s,"FLOAT","VEC3"),c=t.getData("SCALE",s,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const h=new Map,d=[];n.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:r}=e,n=new w.InstancedMesh(t,r,s);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),d.push(n),h.set(e,n)}}));const u=new w.Vector3;for(let e=0;e<s;e++)u.x+=i[3*e+0]/s,u.y+=i[3*e+1]/s,u.z+=i[3*e+2]/s;h.forEach(((e,t)=>{const r=t.parent;r&&(r.remove(t),r.add(e),e.updateMatrixWorld(),e.position.copy(u).applyMatrix4(e.matrixWorld))}));for(let e=0;e<s;e++){L.set(i[3*e+0]-u.x,i[3*e+1]-u.y,i[3*e+2]-u.z),o?(C.set(o[3*e+0],o[3*e+1],o[3*e+2]),S.set(a[3*e+0],a[3*e+1],a[3*e+2]),y.crossVectors(S,C).normalize(),A.makeBasis(S,C,y),v.setFromRotationMatrix(A)):v.set(0,0,0,1),c?U.setScalar(c[e]):l?U.set(l[3*e+0],l[3*e+1],l[3*e+2]):U.set(1,1,1),A.compose(L,v,U);for(let t=0,r=d.length;t<r;t++){d[t].setMatrixAt(e,A)}}n.batchTable=r,n.featureTable=t,n.scene.batchTable=r,n.scene.featureTable=t,e(n)}),s)}))}))}}class CMPTLoaderBase extends LoaderBase{constructor(){super()}parse(e){const t=new DataView(e),r=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("cmpt"===r,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const s=t.getUint32(8,!0);console.assert(s===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),o=[];let a=16;for(let t=0;t<i;t++){const t=new DataView(e,a,12),r=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3)),n=t.getUint32(4,!0),s=t.getUint32(8,!0),i=new Uint8Array(e,a,s);o.push({type:r,buffer:i,version:n}),a+=s}return{version:n,tiles:o}}}class GLTFExtensionLoader extends LoaderBase{constructor(e=w.DefaultLoadingManager){super(),this.manager=e}parse(e){return new Promise(((t,r)=>{const n=this.manager;let s=n.getHandler("path.gltf")||n.getHandler("path.glb")||new x.GLTFLoader(n);const i=s.resourcePath||s.path||this.workingPath;s.parse(e,i,(e=>{t(e)}),r)}))}}class CMPTLoader extends CMPTLoaderBase{constructor(e=w.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),r=this.manager,n=[];for(const e in t.tiles){const{type:s,buffer:i}=t.tiles[e];switch(s){case"b3dm":{const e=i.slice(),t=new B3DMLoader(r);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);n.push(s);break}case"pnts":{const e=i.slice(),t=new PNTSLoader(r);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);n.push(s);break}case"i3dm":{const e=i.slice(),t=new I3DMLoader(r);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);n.push(s);break}case"glb":case"gltf":const e=i.slice(),t=new GLTFExtensionLoader(r);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);n.push(s)}}return Promise.all(n).then((e=>{const t=new w.Group;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}const M=new w.Matrix4;class TilesGroup extends w.Group{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?M.copy(this.matrix):M.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=M.elements,t=this.matrixWorld.elements;let r=!1;for(let n=0;n<16;n++){const s=e[n],i=t[n];if(Math.abs(s-i)>Number.EPSILON){r=!0;break}}if(r){this.matrixWorld.copy(M);const e=this.children;for(let t=0,r=e.length;t<r;t++)e[t].updateMatrixWorld()}}}}const R=new w.Sphere,E=new w.Matrix4,P=new w.Vector3,k=new w.Vector3,O=new w.Ray,F=[];function I(e,t){return e.distance-t.distance}function D(e,t,r){e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,r)}))}function V(e,t,r,n){if(r.has(e)){if(D(e.cached.scene,n,F),F.length>0){F.length>1&&F.sort(I);const e=F[0];return F.length=0,e}return null}const s=[],i=e.children;for(let e=0,r=i.length;e<r;e++){const r=i[e],o=r.cached,a=t.matrixWorld;E.copy(a);const l=o.sphere;if(l&&(R.copy(l),R.applyMatrix4(E),!n.ray.intersectsSphere(R)))continue;const c=o.box,h=o.boxTransform;if(c){if(E.multiply(h).invert(),O.copy(n.ray),O.applyMatrix4(E),!O.intersectBox(c,P))continue;{let e;k.setFromMatrixScale(E),e=k.x,Math.abs(Math.max(k.x-k.y,k.x-k.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when raycasting.");let t={distance:1/0,tile:null};s.push(t),t.distance=P.distanceToSquared(O.origin)*e*e,t.tile=r}}}s.sort(I);let o=1/0,a=null;for(let e=0,i=s.length;e<i;e++){const i=s[e];if(i.distance>o)break;{const e=i.tile,s=e.cached.scene;let l=null;if(r.has(e)?(D(s,n,F),F.length>0&&(F.length>1&&F.sort(I),l=F[0])):l=V(e,t,r,n),l){const e=l.distance*l.distance;e<o&&(o=e,a=l),F.length=0}}}return a}function N(e,t,r,n,s){const i=e.cached,o=t.matrixWorld;E.copy(o);const a=i.sphere;if(a&&(R.copy(a),R.applyMatrix4(E),!n.ray.intersectsSphere(R)))return;const l=i.box,c=i.boxTransform;if(l&&(E.multiply(c).invert(),O.copy(n.ray).applyMatrix4(E),!O.intersectsBox(l)))return;const h=i.scene;if(r.has(e))return void D(h,n,s);const d=e.children;for(let e=0,i=d.length;e<i;e++)N(d[e],t,r,n,s)}const B=Symbol("INITIAL_FRUSTUM_CULLED"),z=new w.Matrix4,G=new w.Matrix4,W=new w.Vector3,j=new w.Vector3,H=new w.Vector3,J=new w.Vector3,$=new w.Vector3(1,0,0),Q=new w.Vector3(0,1,0);function q(e,t){e.traverse((e=>{e.frustumCulled=e[B]&&t}))}class TilesRenderer extends class TilesRendererBase{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new LRUCache;t.unloadPriorityCallback=b;const r=new i.Z;r.maxJobs=4,r.priorityCallback=m;const n=new i.Z;n.maxJobs=1,n.priorityCallback=m,this.lruCache=t,this.downloadQueue=r,this.parseQueue=n,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const r=this.tileSets[this.rootURL];r&&r.root&&u(r.root,e,t)}update(){const e=this.stats,t=this.lruCache,r=this.tileSets,n=r[this.rootURL];if(!(this.rootURL in r))return void this.loadRootTileSet(this.rootURL);if(!n||!n.root)return;const s=n.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,p(s,this),f(s,this),g(s,this),_(s,this),t.scheduleUnload()}parseTile(e,t,r){return null}disposeTile(e){}preprocessNode(e,t,r){e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=function(...e){const t=/^[a-zA-Z]+:\/\//;let r=-1;for(let n=0,s=e.length;n<s;n++)t.test(e[n])&&(r=n);if(-1===r)return n.join(...e).replace(/\\/g,"/");{const s=r<=0?e:e.slice(r),i=s[0].match(t)[0];return s[0]=s[0].substring(i.length),(i+n.join(...s)).replace(/\\/g,"/")}}(r,e.content.uri)),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=t,e.children=e.children||[];if(e.content&&e.content.uri){const t=s(e.content.uri),r=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=r,e.__contentEmpty=r}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=o.Jk,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===t?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=t.__depth+1,e.refine=e.refine||t.refine)}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}fetchTileSet(e,t,r=null){return fetch(e,t).then((t=>{if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>{const s=t.asset.version;console.assert("1.0"===s||"0.0"===s,'asset.version is expected to be a string of "1.0" or "0.0"');const i=n.dirname(e);return u(t.root,((e,t)=>this.preprocessNode(e,t,i)),null,r,r?r.__depth:0),t}))}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const r=this.fetchTileSet(e,this.fetchOptions).then((r=>{t[e]=r}));return r.catch((r=>{console.error(r),t[e]=r})),t[e]=r,r}}requestTileContents(e){if(e.__loadingState!==o.Jk)return;const t=this.stats,r=this.lruCache,n=this.downloadQueue,i=this.parseQueue,a=e.__externalTileSet;r.add(e,(e=>{e.__loadingState===o.br?(e.__loadAbort.abort(),e.__loadAbort=null):a?e.children.length=0:this.disposeTile(e),e.__loadingState===o.br?t.downloading--:e.__loadingState===o.yX&&t.parsing--,e.__loadingState=o.Jk,e.__loadIndex++,i.remove(e),n.remove(e)})),e.__loadIndex++;const l=e.__loadIndex,c=new AbortController,h=c.signal;t.downloading++,e.__loadAbort=c,e.__loadingState=o.br;const d=s=>{e.__loadIndex===l&&("AbortError"!==s.name?(i.remove(e),n.remove(e),e.__loadingState===o.yX?t.parsing--:e.__loadingState===o.br&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(s),e.__loadingState=o.ig):r.remove(e))};a?n.add(e,(e=>{if(e.__loadIndex!==l)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return this.fetchTileSet(t,Object.assign({signal:h},this.fetchOptions),e)})).then((r=>{e.__loadIndex===l&&(t.downloading--,e.__loadAbort=null,e.__loadingState=o.tE,e.children.push(r.root))})).catch(d):n.add(e,(e=>{if(e.__loadIndex!==l)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return fetch(t,Object.assign({signal:h},this.fetchOptions))})).then((t=>{if(e.__loadIndex===l){if(t.ok)return t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((r=>{if(e.__loadIndex===l)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=o.yX,i.add(e,(e=>{if(e.__loadIndex!==l)return Promise.resolve();const t=s(e.content.uri);return this.parseTile(r,e,t)}))})).then((()=>{e.__loadIndex===l&&(t.parsing--,e.__loadingState=o.tE,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch(d)}dispose(){const e=this.lruCache;this.traverse((t=>{e.remove(t)}))}}{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{q(t,!e)})))}constructor(...e){super(...e),this.group=new TilesGroup(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null;const t=new w.LoadingManager;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t;const r=this;this._overridenRaycast=function(e,t){r.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,e,t)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached,r=t.box,n=t.boxTransform;return!!r&&(e.copy(r),e.applyMatrix4(n),!0)}getOrientedBounds(e,t){if(!this.root)return!1;const r=this.root.cached,n=r.box,s=r.boxTransform;return!!n&&(e.copy(n),t.copy(s),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.sphere;return!!t&&(e.copy(t),!0)}forEachLoadedModel(e){this.traverse((t=>{const r=t.cached.scene;r&&e(r,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const r=V(this.root,this.group,this.activeTiles,e);r&&t.push(r)}else N(this.root,this.group,this.activeTiles,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,r=this.cameraMap;return!r.has(e)&&(r.set(e,new w.Vector2),t.push(e),!0)}setResolution(e,t,r){const n=this.cameraMap;return!!n.has(e)&&(t instanceof w.Vector2?n.get(e).copy(t):n.get(e).set(t,r),!0)}setResolutionFromRenderer(e,t){const r=this.cameraMap;if(!r.has(e))return!1;const n=r.get(e);return t.getSize(n),n.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,r=this.cameraMap;if(r.has(e)){const n=t.indexOf(e);return t.splice(n,1),r.delete(e),!0}return!1}fetchTileSet(e,...t){const r=super.fetchTileSet(e,...t);return r.then((t=>{this.onLoadTileSet&&Promise.resolve().then((()=>{this.onLoadTileSet(t,e)}))})),r}update(){const e=this.group,t=this.cameras,r=this.cameraMap,n=this.cameraInfo;if(0===t.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;n.length>t.length;)n.pop();for(;n.length<t.length;)n.push({frustum:new w.Frustum,isOrthographic:!1,sseDenominator:-1,position:new w.Vector3,invScale:-1,pixelSize:0});let s;G.copy(e.matrixWorld).invert(),W.setFromMatrixScale(G),s=W.x,Math.abs(Math.max(W.x-W.y,W.x-W.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,o=n.length;i<o;i++){const o=t[i],a=n[i],l=a.frustum,c=a.position,h=r.get(o);0!==h.width&&0!==h.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=o.projectionMatrix.elements;if(a.isOrthographic=1===d[15],a.isOrthographic){const e=2/d[0],t=2/d[5];a.pixelSize=Math.max(t/h.height,e/h.width)}else a.sseDenominator=2/d[5]/h.height;a.invScale=s,z.copy(e.matrixWorld),z.premultiply(o.matrixWorldInverse),z.premultiply(o.projectionMatrix),l.setFromProjectionMatrix(z),c.set(0,0,0),c.applyMatrix4(o.matrixWorld),c.applyMatrix4(G)}super.update()}preprocessNode(e,t,r){super.preprocessNode(e,t,r);const n=new w.Matrix4;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)n.elements[e]=t[e]}else n.identity();t&&n.premultiply(t.cached.transform);const s=(new w.Matrix4).copy(n).invert();let i=null,o=null,a=null;if("box"in e.boundingVolume){const t=e.boundingVolume.box;i=new w.Box3,o=new w.Matrix4,a=new w.Matrix4,j.set(t[3],t[4],t[5]),H.set(t[6],t[7],t[8]),J.set(t[9],t[10],t[11]);const r=j.length(),s=H.length(),l=J.length();j.normalize(),H.normalize(),J.normalize(),0===r&&j.crossVectors(H,J),0===s&&H.crossVectors(j,J),0===l&&J.crossVectors(j,H),o.set(j.x,H.x,J.x,t[0],j.y,H.y,J.y,t[1],j.z,H.z,J.z,t[2],0,0,0,1),o.premultiply(n),a.copy(o).invert(),i.min.set(-r,-s,-l),i.max.set(r,s,l)}let l=null;if("sphere"in e.boundingVolume){const t=e.boundingVolume.sphere;l=new w.Sphere,l.center.set(t[0],t[1],t[2]),l.radius=t[3],l.applyMatrix4(n)}else if("box"in e.boundingVolume){const t=e.boundingVolume.box;l=new w.Sphere,i.getBoundingSphere(l),l.center.set(t[0],t[1],t[2]),l.applyMatrix4(n)}"region"in e.boundingVolume&&console.warn("ThreeTilesRenderer: region bounding volume not supported."),e.cached={loadIndex:0,transform:n,transformInverse:s,active:!1,inFrustum:[],box:i,boxTransform:o,boxTransformInverse:a,sphere:l,region:null,scene:null,geometry:null,material:null}}parseTile(e,t,r){t._loadIndex=t._loadIndex||0,t._loadIndex++;const n=t.content.uri.split(/[\\\/]/g);n.pop();const s=n.join("/"),i=this.fetchOptions,o=this.manager,a=t._loadIndex;let l=null;switch(r){case"b3dm":{const t=new B3DMLoader(o);t.workingPath=s,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"pnts":{const t=new PNTSLoader(o);t.workingPath=s,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"i3dm":{const t=new I3DMLoader(o);t.workingPath=s,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"cmpt":{const t=new CMPTLoader(o);t.workingPath=s,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":const t=new GLTFExtensionLoader(o);t.workingPath=s,t.fetchOptions=i,l=t.parse(e).then((e=>e.scene));break;default:console.warn(`TilesRenderer: Content type "${r}" not supported.`),l=Promise.resolve(null)}return l.then((e=>{if(t._loadIndex!==a)return;const n=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",s=t.cached,i=s.transform;switch(n.toLowerCase()){case"x":z.makeRotationAxis(Q,-Math.PI/2);break;case"y":z.makeRotationAxis($,Math.PI/2);break;case"z":z.identity()}e.updateMatrix(),"pnts"!==r&&e.matrix.multiply(z),e.matrix.premultiply(i),e.matrix.decompose(e.position,e.quaternion,e.scale),e.traverse((e=>{e[B]=e.frustumCulled})),q(e,!this.autoDisableRendererCulling),s.scene=e,e.traverse((e=>{e.raycast=this._overridenRaycast}));const o=[],l=[],c=[];e.traverse((e=>{if(e.geometry&&l.push(e.geometry),e.material){const t=e.material;o.push(e.material);for(const e in t){const r=t[e];r&&r.isTexture&&c.push(r)}}})),s.materials=o,s.geometry=l,s.textures=c,this.onLoadModel&&this.onLoadModel(e,t)}))}disposeTile(e){const t=e.cached;if(t.scene){const r=t.materials,n=t.geometry,s=t.textures;for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=r.length;e<t;e++)r[e].dispose();for(let e=0,t=s.length;e<t;e++){s[e].dispose()}this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}setTileVisible(e,t){const r=e.cached.scene,n=this.visibleTiles,s=this.group;t?(s.add(r),n.add(e),r.updateMatrixWorld(!0)):(s.remove(r),n.delete(e))}setTileActive(e,t){const r=this.activeTiles;t?r.add(e):r.delete(e)}calculateError(e){const t=e.cached,r=t.inFrustum,n=this.cameras,s=this.cameraInfo,i=e.boundingVolume;if("box"in i||"sphere"in i){const i=t.sphere,o=t.box,a=t.boxTransformInverse,l=t.transformInverse,c=o&&a;let h=-1/0,d=1/0;for(let t=0,u=n.length;t<u;t++){if(!r[t])continue;const n=s[t],u=n.invScale;let p;if(n.isOrthographic){const t=n.pixelSize;p=e.geometricError/(t*u)}else{let t;W.copy(n.position),c?(W.applyMatrix4(a),t=o.distanceToPoint(W)):(W.applyMatrix4(l),t=Math.max(i.distanceToPoint(W),0));const r=t*u,s=n.sseDenominator;p=e.geometricError/(r*s),d=Math.min(d,r)}h=Math.max(h,p)}e.__distanceFromCamera=d,e.__error=h}else"region"in i&&console.warn("ThreeTilesRenderer : Region bounds not supported.")}tileInView(e){const t=e.cached,r=t.sphere,n=t.inFrustum;if(r){const e=this.cameraInfo;let t=!1;for(let s=0,i=e.length;s<i;s++){e[s].frustum.intersectsSphere(r)?(t=!0,n[s]=!0):n[s]=!1}return t}return!0}}},80122:(e,t,r)=>{"use strict";r.d(t,{Z:()=>PriorityQueue});class PriorityQueue{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((r,n)=>{const s=this.items,i=this.callbacks;s.push(e),i.set(e,((...e)=>t(...e).then(r).catch(n))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,r=this.callbacks,n=t.indexOf(e);-1!==n&&(t.splice(n,1),r.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,r=this.maxJobs;let n=this.currJobs;for(;r>n&&e.length>0;){n++;const r=e.pop(),s=t.get(r);t.delete(r),s(r).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=n}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}}}]);