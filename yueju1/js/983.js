(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[983],{68373:(e,t,s)=>{"use strict";s.d(t,{$:()=>i,y:()=>MttrParseQueue});var i,r=s(80122),o=s(59855);!function(e){e.DEFAULT="DEFAULT",e.DEFAULT_FRUSTUM="DEFAULT_FRUSTUM",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH",e.STRICT_ERROR="STRICT_ERROR"}(i||(i={}));class MttrParseQueue extends r.Z{constructor(){super(...arguments),this.prioritizeBy=o.t.parsePriority,this.priorityCallback=(e,t)=>{switch(this.prioritizeBy=o.t.parsePriority,this.prioritizeBy){case i.STRICT_ERROR:return this.byRawError(e,t);case i.DEFAULT_FRUSTUM:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>e.__depth,e=>Number(e.__used),e=>e.__error,e=>e.__distanceFromCamera]);case i.FRUSTUM_ERROR_THRESH:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=o.t.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]);default:return this.defaultPriorityCallback(e,t)}}}byRawError(e,t){return e.__error>t.__error?-1:1}sortBySelectors(e,t,s){for(const i of s){const s=this.compareTile(e,t,i);if(null!==s)return s}return 0}compareTile(e,t,s){const i=s(e),r=s(t);return i===r?null:i>r?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}},59855:(e,t,s)=>{"use strict";s.d(t,{t:()=>l});var i=s(17597),r=s(20331),o=s(68373),n=s(60771),a=s(17916);const l={urlTemplateToken:"<file>",hideMenu:"1"!==(0,i.eY)("dmenu","0"),debug:"1"===(0,i.eY)("debugTiles","0"),displayBoxBounds:!1,initialMaxLOD:0,maxLOD:(0,i.eY)("maxLOD",a.V.Detail),loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,statsTiles:!0,statsTextures:!1,statsTextureStream:!1,errorTarget:Number((0,i.eY)("errorTarget",4)),disableTileUpdates:!1,errorMultiplierRaycastOcclusion:.1,errorMultiplierHiddenFloors:.01,disposeModel:!1,limitMemoryUsage:(0,n.tq)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,n.tq)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,tileAssetRequestPriority:r.RequestPriority.MEDIUM,downloadQueueConcurrency:8,parseQueueConcurrency:10,parsePriority:o.$.FRUSTUM_ERROR_THRESH,snappingMaxLOD:a.V.Standard}},92132:(e,t,s)=>{"use strict";s.r(t),s.d(t,{createModelMesh:()=>q});var i=s(96909),r=s(59088),o=s(17915),n=s(62955),a=s(21922),l=s(51245),d=s(2212),h=s(88512),u=s(41038),c=s(91283),m=s(59855),p=s(44283),g=s(80122),T=s(17916);class MttrDownloadQueue extends g.Z{constructor(e,t,s,i){super(),this.urlSigner=e,this.modelUrls=t,this.onProgress=i,this.priorityCallback=s}add(e,t){return super.add(e,(async e=>{var s,i,r;if(null===(s=null==e?void 0:e.content)||void 0===s?void 0:s.uri){const s=e.content.uri;try{const o=null===(i=this.onProgress)||void 0===i?void 0:i.bind(this,e);if(e.content.uri=await this.urlSigner(s),(null===(r=e.extras)||void 0===r?void 0:r.level)===T.V.Min)return t(e).then((e=>o?function(e,t){if(e.ok&&e.body){const s=e.body.getReader(),i=e.headers.get("Content-Length");let r=i?+i:0,o=0!==r,n=0;const a=new ReadableStream({async start(e){for(;;){const{done:i,value:a}=await s.read();if(a&&(n+=a.byteLength,e.enqueue(a)),i&&(r=n,o=!0),null==t||t(new ProgressEvent("progress",{lengthComputable:o,loaded:n,total:r})),i){e.close();break}}}});e=new Response(a)}return e}(e,o):e));{const s=window.fetch;try{return window.fetch=async(e,t)=>{const s=await this.modelUrls.getFile(e,{responseType:"blob",priority:m.t.tileAssetRequestPriority,onProgress:o,signal:null==t?void 0:t.signal});return new Response(s)},t(e)}finally{window.fetch=s}}}finally{e.content.uri=s}}}))}}var f=s(19131);var y=s(84561),M=s(96367);class MTTRMeshBvh{constructor(e){this.parser=e,this.name="MTTR_three_mesh_bvh"}async loadMesh(e){const t=async(t,s)=>{var i,r;const o=this.parser.json.meshes[e].primitives[s];if(null===(i=o.extensions)||void 0===i?void 0:i.MTTR_three_mesh_bvh){const e=null===(r=o.extensions)||void 0===r?void 0:r.MTTR_three_mesh_bvh,s={roots:(await Promise.all(e.roots.map((e=>this.parser.loadAccessor(e))))).map((e=>{const t=e.array;return t.byteLength!==t.buffer.byteLength?t.slice().buffer:t.buffer})),index:new Uint8Array(0)};t.geometry.boundsTree=M.r.deserialize(s,t.geometry,{setIndex:!1})}},s=[],i=await this.loadMeshInternal(e);if(i)if("Group"===i.type){const e=i;s.push(...e.children.map(((e,s)=>t(e,s))))}else"Mesh"===i.type&&s.push(t(i,0));return await Promise.all(s),i}async loadMeshInternal(e){const t=this.parser,s=t,i=this.parser.json.meshes[e],r=i.primitives,o=[];for(let e=0,i=r.length;e<i;e++){const i=void 0===r[e].material?t.createDefaultMaterial(s.cache):t.getDependency("material",r[e].material);o.push(i)}return o.push(t.loadGeometries(r)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),n=s[s.length-1],l=[];for(let s=0,d=n.length;s<d;s++){const d=n[s],h=r[s];let u;const c=o[s];if(h.mode!==v.TRIANGLES&&void 0!==h.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new a.g(0,0,y.o.DEFAULT),u.geometry=d,u.material=c,u.name=t.createUniqueName(i.name||"mesh_"+e),L(u,i),t.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];const h=new d.Group;for(let e=0,t=l.length;e<t;e++)h.add(l[e]);return h}))}}const v={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function L(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}var b=s(10338),x=s(17047);class CrossModelTextureCache{constructor(e){this.parser=e,this.name="CrossModelTextureCache"}static addToLoader(e){e.pluginCallbacks.unshift((e=>new CrossModelTextureCache(e)))}loadTexture(e){var t;const s=this.parser,i=s.json,r=i.textures[e];let o=r.source;Object.keys(r.extensions).forEach((e=>o=o||r.extensions[e].source));const n=null===(t=i.images[o])||void 0===t?void 0:t.uri;if(void 0===n)return null;const a=w.get(n);if(a)return a;let l=s._invokeOne((t=>t===this?null:t.loadTexture&&t.loadTexture(e)));l||(l=s.loadTexture(e));const d=l.then((e=>{const t=()=>{w.delete(n),e.removeEventListener("dispose",t)};return e.addEventListener("dispose",t),e}));return w.set(n,d),d}}const w=new Map;var _=s(69138);let S,R;function C(e,t,s,i){return S||(S=new MttrKTX2Loader(s,i),S.setTranscoderPath("libs/three@0.134.0/basis/"),S.detectSupport(e),S.manager=t,S.preload(),S)}class MttrKTX2Loader extends _.KTX2Loader{constructor(e,t){super(),this.urlSigner=e,this.modelUrls=t,this.taskCache=new WeakMap}load(e,t,s,i){const r=new d.CompressedTexture([],0,0);return this.urlSigner(e).then((async e=>{const i=await this.modelUrls.getFile(e,{onProgress:s,responseType:"arraybuffer",priority:m.t.tileAssetRequestPriority});let o=this.taskCache.get(i);if(!o){o={promise:this._createTexture([i])},this.taskCache.set(i,o)}const n=await o.promise;r.copy(n),r.needsUpdate=!0,t(r)})).catch(i),r}preload(){this.init()}}var k=s(67502),E=s(64185),D=s(62330),A=s(68373);const U=new h.Z("tiled-mesh"),F=(c.Jk,c.br,c.yX,c.tE);c.ig;class MttrTileLoader{constructor(e,t,s,i,r,o){this.container=e,this.chunkFactory=s,this.tilesetInfo=i,this.commandBinder=r,this.modelUrls=o,this.name="MttrTileLoader",this.loadStats={startTimes:{start:0,tileset:0,texinfo:0,lod0:0,lod1:0},timings:{tileset:"",texinfo:"",lod0:"",lod1:""}},this.lodDeferreds=[],this.tileProgress=new WeakMap,this.onChunksLoaded=new Set,this.onChunksUnloaded=new Set,this.tileSetLoaded=!1,this.minimalLoaded=!1,this.minimalTileCount=0,this.signUrl=async e=>{if(e.startsWith("blob"))return e;return(await this.tilesetInfo.urlTemplate.get()).replace(m.t.urlTemplateToken,e)},this.onTileDownloadProgress=(e,t)=>{this.tileProgress.set(e,t.lengthComputable?t.loaded/t.total:0),this.checkLoadStatus()},this.checkLoadStatus=(()=>{const e=[];let t=!1,s=!1;return(0,D.P)((()=>{t&&s||!this.tileSetLoaded||(0===e.length&&(e.push([],[]),this.tilesRenderer.traverse(((t,s,i)=>{var r;const o=null===(r=t.extras)||void 0===r?void 0:r.level;return 0!==o&&1!==o||e[o].push(t),!1}),null)),t||(t=this.notifyIfFullyLoaded(0,e,!0),t&&(U.debug("LOD0 fully downloaded, allow showing more lods"),this.minimalLoaded=!0,this.minimalTileCount=e[0].length,this.loadStats.timings.lod0=(performance.now()-this.loadStats.startTimes.lod0).toFixed(1)+"ms",this.loadStats.startTimes.lod1=performance.now())),s||(s=this.notifyIfFullyLoaded(1,e,!1),s&&(this.loadStats.timings.lod1=(performance.now()-this.loadStats.startTimes.lod1).toFixed(1)+"ms",e.length=0)))}),16)})(),this.loadStats.startTimes.start=performance.now(),this.loadStats.startTimes.texinfo=performance.now(),this.tilesRenderer=new u.I(i.rootURL);const n=function(e,t,s,i){R||(R=new b.DRACOLoader,R.setDecoderPath("libs/three@0.134.0/draco/gltf/"),R.preload());const r=new x.GLTFLoader(t);r.setDRACOLoader(R),r.register((e=>new MTTRMeshBvh(e))),CrossModelTextureCache.addToLoader(r);const o=C(e,t,s,i);return r.setKTX2Loader(o),r}(t,this.tilesRenderer.manager,this.signUrl,o);this.configureTilesRenderer(this.tilesRenderer,n)}setSize(e,t,s){this.tilesRenderer.setCamera(e),this.tilesRenderer.setResolution(e,t,s)}notifyOnChunksLoaded(e){return(0,p.k1)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}notifyOnChunksUnloaded(e){return(0,p.k1)((()=>this.onChunksUnloaded.add(e)),(()=>this.onChunksUnloaded.delete(e)),!0)}notifyOnLodProgress(e,t){this.getLodDeferred(e).progress(t)}awaitLod(e){return this.getLodDeferred(e).nativePromise()}getLodDeferred(e){return this.lodDeferreds[e]||(this.lodDeferreds[e]=new E.Q)}update(){const{minimalLoaded:e,tilesRenderer:t}=this;e?(t.displayActiveTiles=m.t.displayActiveTiles,t.loadSiblings=m.t.loadSiblings,t.optimizeRaycast=m.t.optimizeRaycast,t.stopAtEmptyTiles=m.t.stopAtEmptyTiles,t.autoDisableRendererCulling=m.t.autoDisableRendererCulling,t.downloadQueue.maxJobs=m.t.downloadQueueConcurrency,t.parseQueue.maxJobs=m.t.parseQueueConcurrency):(t.loadSiblings=!0,t.downloadQueue.maxJobs=1/0,t.parseQueue.maxJobs=1/0),t.errorTarget=m.t.errorTarget,t.lruCache.maxSize=e?Math.max(m.t.lruMaxTiles,this.minimalTileCount):1/0,t.update(),t.lruCache.minSize=m.t.lruMinExtraTiles+t.lruCache.usedSet.size,t.lruCache.unloadPercent=m.t.lruUnloadPercent}getDownloadParseStatus(){return this.tilesRenderer.stats}configureTilesRenderer(e,t){const s=e.calculateError.bind(e);e.calculateError=e=>{s(e),this.adjustScreenSpaceError&&(e.__error=this.adjustScreenSpaceError(e.__error,e))},e.manager.addHandler(/\gltf$/,t),e.manager.addHandler(/\glb$/,t),e.errorTarget=m.t.errorTarget,e.loadSiblings=m.t.loadSiblings,e.stopAtEmptyTiles=m.t.stopAtEmptyTiles,e.displayActiveTiles=m.t.displayActiveTiles;const i=e.preprocessNode.bind(e);e.preprocessNode=function(e,t,s){return i(e,t,"")},this.configurePriorityQueues(),this.container.add(e.group);const r=(new d.Quaternion).setFromAxisAngle(new d.Vector3(-1,0,0),d.MathUtils.degToRad(90));this.container.quaternion.copy(r),this.container.updateMatrixWorld(!0),e.onLoadTileSet=this.onLoadTileset.bind(this),e.onLoadModel=this.onLoadModel.bind(this),e.onDisposeModel=this.onDisposeModel.bind(this);const o=e.setTileActive.bind(e);e.setTileActive=(e,t)=>{o(e,t),this.onTileActiveChange&&this.onTileActiveChange(e,t)};const n=e.setTileVisible.bind(e);e.setTileVisible=(e,t)=>{n(e,t),this.onTileVisibleChange&&this.onTileVisibleChange(e,t)};const a=e.tileInView.bind(e);e.tileInView=e=>{var t;let s=-1;for(let i=e.parent;i;i=i.parent){const e=null===(t=i.extras)||void 0===t?void 0:t.level;if("number"==typeof e){s=e;break}}return!(s>=(this.minimalLoaded?m.t.maxLOD:m.t.initialMaxLOD))&&a(e)}}configurePriorityQueues(){const{tilesRenderer:e}=this;e.downloadQueue=new MttrDownloadQueue(this.signUrl,this.modelUrls,e.downloadQueue.priorityCallback,this.onTileDownloadProgress),e.parseQueue=new A.y;const t=e=>{this.commandBinder.issueCommand(new k._("mesh/tiled/priorityQueue",e,100))};e.parseQueue.schedulingCallback=t,e.downloadQueue.schedulingCallback=t}async onLoadModel(e,t){const s=function(e,t,s){var i;const r=[],o=(null===(i=t.extras)||void 0===i?void 0:i.id)||""+e.id;return e.name=o,e.traverse((e=>{var i;if(e.matrixAutoUpdate=!1,e instanceof a.g){const{group:n,subgroup:a,chunkIndex:l}=(0,f.xc)(`${o}-${e.name}`),d=e.material,h=d.map;let u=null==h?void 0:h.name;u||(u=d.name.replace(".jpg",""));const c=s(n,a,e.geometry,u);c.textureLODInfo=function(e,t){if(t&&(null==t?void 0:t.maxTextureSize)&&(null==t?void 0:t.texelSize)&&(null==t?void 0:t.textureScale)&&t.textureScale>0){const s=t.textureScale;return{name:e,maxTexelSize:.001*t.texelSize,maxTextureSize:t.maxTextureSize,minTexelSize:1/s*t.texelSize*.001,minTextureSize:s*t.maxTextureSize,minScale:s}}return null}(u,t.extras)||void 0,c.lod=(null===(i=t.extras)||void 0===i?void 0:i.level)||0,c.chunkIndex=l,c.notifyOnMaterialUpdated((t=>{e.material=t}));const m={};m.map=h,e.buildWithTileChunk(c),e.material=c.setMaterialsUniform(m),c.name=e.name,c.embeddedTexture=m.map,r.push(c)}})),r}(e,t,this.chunkFactory);for(const e of s)this.container.addChunk(e);for(const e of this.onChunksLoaded.values())e(s,t);this.onModelLoaded&&this.onModelLoaded(e,t),await new Promise((e=>setTimeout(e,0))),this.checkLoadStatus()}onDisposeModel(e,t){e.traverse((e=>{if((0,l.oR)(e)){const s=e.chunks;if(!s)return void U.error("Missing chunks from RoomMesh");for(const e of s)this.container.removeChunk(e);for(const e of this.onChunksUnloaded.values())e(s,t)}})),this.onModelUnloaded&&this.onModelUnloaded(e,t),e.traverse((e=>{(0,l.oR)(e)&&e.reset()}))}onLoadTileset(e,t){var s;const i=!this.loadStats.startTimes.lod0;let r="";i&&(r=(performance.now()-this.loadStats.startTimes.start).toFixed(1),this.loadStats.timings.tileset=r+"ms");const o=null===(s=t.match(/[^/]*\.json/))||void 0===s?void 0:s[0];U.debug(`Tileset ${o} load${i?`: ${r}ms`:""}`,e),i&&(this.loadStats.startTimes.lod0=performance.now()),this.tileSetLoaded=!0,this.tilesRenderer.update()}notifyIfFullyLoaded(e,t,s){if(!t[e])return!1;const i=t[e],r=i.filter((e=>e.__loadingState!==F)),o=this.getLodDeferred(e);return s&&o.notify(i.reduce(((e,t)=>e+(this.tileProgress.get(t)||0)/i.length),0)),0===r.length&&o.resolve(),0===r.length}}var P=s(2388),O=s(67790),I=s(93331),B=s(6559);const z=new d.Vector3,V=(new d.Matrix4).set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),N=V.clone().invert();function Q(e,t){if(!1!==t(e)&&e.children)for(const s of e.children)Q(s,t)}function H(e,t){const{box:s,boxTransformInverse:i}=function(e){let t=G.get(e);if(!t){const s=e.boundingVolume.box,i=new d.Box3,r=new d.Matrix4,o=new d.Vector3(s[3],s[4],s[5]),n=new d.Vector3(s[6],s[7],s[8]),a=new d.Vector3(s[9],s[10],s[11]),l=o.length(),h=n.length(),u=a.length();o.normalize(),n.normalize(),a.normalize(),0===l&&o.crossVectors(n,a),0===h&&n.crossVectors(o,a),0===u&&a.crossVectors(o,n),r.set(o.x,n.x,a.x,s[0],o.y,n.y,a.y,s[1],o.z,n.z,a.z,s[2],0,0,0,1).invert(),i.min.set(-l,-h,-u),i.max.set(l,h,u),t={box:i,boxTransformInverse:r},G.set(e,t)}return t}(t);return z.copy(e).applyMatrix4(V).applyMatrix4(i),s.containsPoint(z)}const G=new WeakMap;var j=s(26128),W=s(15443);class ModelMeshTiled extends n.e{constructor(e){super(),this.uuid=e,this.boundingBox=new d.Box3,this.size=new d.Vector3,this.center=new d.Vector3,this.bindings=[],this.roomMeshesByTile=new Map,this.activeRoomMeshes=new Set,this.visibleRoomMeshes=new Set,this.activeTiles=new Set,this.tileActiveDescendantCounts=new WeakMap,this.tilesByChunkId=new Map,this.isActiveRoomMeshFilter=e=>this.activeRoomMeshes.has(e),this.isActiveRoomMeshSnapFilter=e=>{var t,s,i;const r=null===(t=e.meta)||void 0===t?void 0:t.tile;if(r){const{snappingMaxLOD:e}=m.t,t=null!==(i=null===(s=r.extras)||void 0===s?void 0:s.level)&&void 0!==i?i:1/0;if(t===e&&(this.tileActiveDescendantCounts.get(r)||0)>0||t<=e&&this.activeTiles.has(r))return!0}return!1}}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings=[]}async load(e,t,s,i,r,o,n,d,h){this.renderer=t,o.root=this,this.tileLoader=new MttrTileLoader(this,t.threeRenderer,n,r,e.commandBinder,h),this.tileLoader.setSize(s,i.width,i.height),this.bindings.push(e.subscribe(O.a,(e=>{this.tileLoader.setSize(s,e.width,e.height)}))),this.tileLoader.onModelLoaded=(e,t)=>{let s=this.roomMeshesByTile.get(t);s||(s=[],this.roomMeshesByTile.set(t,s)),e.traverse((e=>{(0,l.oR)(e)&&(o.rooms.add(e),s.push(e),this.inputIni&&this.registerMeshForCollision(this.inputIni,e,t))})),o.commit()},this.tileLoader.onModelUnloaded=(e,t)=>{e.traverse((e=>{e instanceof a.g&&(o.rooms.delete(e),this.inputIni&&this.unregisterMeshFromCollision(this.inputIni,e))})),o.commit(),this.tileLoader.onTileActiveChange(t,!1),this.tileLoader.onTileVisibleChange(t,!1),this.roomMeshesByTile.delete(t)},this.tileLoader.onTileActiveChange=(e,t)=>{var s;const i=t?"add":"delete";null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.activeRoomMeshes[i](e)})),this.activeTiles[i](e);for(let s=e.parent;s;s=s.parent){const e=this.tileActiveDescendantCounts.get(s)||0;this.tileActiveDescendantCounts.set(s,e+(t?1:-1))}},this.tileLoader.onTileVisibleChange=(e,t)=>{var s;null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.visibleRoomMeshes[t?"add":"delete"](e)}))},this.initTileLodAdjustments(this.tileLoader,d),this.tileLoader.notifyOnLodProgress(0,(t=>{e.broadcast(new I.Z(t,1))})),this.tileLoader.update(),await this.tileLoader.awaitLod(0),this.tileLoader.tilesRenderer.getBounds(this.boundingBox),this.boundingBox.applyMatrix4(N),this.boundingBox.getSize(this.size),this.boundingBox.getCenter(this.center),e.broadcast(new j.em(W.Y.StreamingMesh)),e.broadcast(new j.em(W.Y.StreamingTexture))}initTextureLoader(e,t){return(0,B.qT)().limitStreamingBelow(P.ZP.disableTextureStreamBelowLod),e.autoLoadTiles=!1,e.setModel(this,this._chunks,t,(()=>m.t.limitMemoryUsage?m.t.allocatedMegsBeforeLimitingLod*2**20:1/0)),this.bindings.push(this.tileLoader.notifyOnChunksLoaded((t=>{e.addChunkSlots(t);for(const e of this.onChunksLoaded.values())e(t)})),this.tileLoader.notifyOnChunksUnloaded((t=>{e.removeChunks(t)}))),e.allowTextureDownload=()=>{const{downloading:e,parsing:t}=this.tileLoader.getDownloadParseStatus();return 0===e&&0===t},Promise.resolve()}initTileLodAdjustments(e,t){const s=this.tilesByChunkId,i=new Map;let r=0;this.bindings.push(e.notifyOnChunksLoaded(((e,t)=>{for(const i of e)s.set(i.id,t)})),t.notifyOnNewSighting(((e,t)=>{r++;const o=s.get(e.id);if(o){for(let e=o.parent;e;e=e.parent)i.set(e,r);Q(o,(e=>!(e!==o&&!H(t.point,e))&&(i.set(e,r),!0)))}})),this.tileLoader.notifyOnChunksUnloaded((e=>{for(const t of e)s.delete(t.id),t.dispose()}))),e.adjustScreenSpaceError=(e,t)=>{var s,o;if(1!==m.t.errorMultiplierRaycastOcclusion){(null!==(s=i.get(t))&&void 0!==s?s:-1/0)<r-P.ZP.sightingMaxAge&&(e*=m.t.errorMultiplierRaycastOcclusion)}if(1!==m.t.errorMultiplierHiddenFloors){(null===(o=this.roomMeshesByTile.get(t))||void 0===o?void 0:o.some((e=>e.chunks.some((e=>e.getOpacity()>P.xx.FADE_DEPTH_WRITE_THRESHOLD)))))||(e*=m.t.errorMultiplierHiddenFloors)}return e}}registerCollision(e){this.inputIni=e,this.tileLoader.tilesRenderer.forEachLoadedModel(((t,s)=>{t.traverse((t=>{(0,l.oR)(t)&&this.registerMeshForCollision(e,t,s)}))}))}registerMeshForCollision(e,t,s){e.registerMesh(t,!0,this.isActiveRoomMeshFilter),t.chunks[0].lod<=m.t.snappingMaxLOD&&e.registerSnappingMeshGeometry(t.name,t.geometry,{tile:s},this.isActiveRoomMeshSnapFilter)}unregisterMeshFromCollision(e,t){e.unregisterMesh(t),e.unregisterSnappingMeshGeometry(t.name)}addChunk(e){this._chunks.push(e)}removeChunk(e){const t=this._chunks.indexOf(e);this._chunks.splice(t,1)}onUpdate(){m.t.disableTileUpdates||(this.tileLoader.update(),this.checkDispose());this.renderer.estimatedGPUMemoryAllocated()>2**20*(m.t.limitMemoryUsage?m.t.allocatedMegsBeforeLimitingLod:1/0)&&m.t.maxLOD>0&&m.t.maxLOD--}setTextureQuality(e,t,s){e.setQuality(B.S7.LOW,s)}get visibleChunks(){const e=this.visibleRoomMeshes;return{*[Symbol.iterator](){for(const t of e)for(const e of t.chunks)yield e}}}checkDispose(){if(m.t.disposeModel){const e=this.tileLoader.tilesRenderer,t=e;for(const e of t.cameras)t.deleteCamera(e);const s=.001,i=new d.OrthographicCamera(-s,s,s,-s,s,2*s);i.position.set(0,-1e4,0),i.rotation.setFromVector3(new d.Vector3(0,-1,0)),i.updateMatrix(),i.updateMatrixWorld(),this.tileLoader.setSize(i,100,100),e.lruCache.minSize=0,e.lruCache.unloadPercent=1,e.lruCache.markAllUnused(),e.update(),e.dispose(),o.z.disposeShared(),m.t.disableTileUpdates=!0}}}async function q({uuid:e,engine:t,settings:s,modelData:o,roomMeshData:n,chunkFactory:a,chunkVisibilityChecker:l,urls:d}){s.flipDownload=!1,s.flipUpload=!1;const h=new ModelMeshTiled(e),[u,c]=await Promise.all([t.getModuleBySymbol(i.y.WEBGL_RENDERER),t.market.waitForData(r.M_)]);return await h.load(t,u,u.getCamera(),c,o.model.tileset,n,a,l,d),h}}}]);