(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[463],{94085:(e,t,i)=>{"use strict";e.exports=i.p+"images/roboto-700-42_0.png"},32867:(e,t,i)=>{"use strict";var r;i.d(t,{Z:()=>s}),function(e){e[e.None=0]="None",e[e.Queued=1]="Queued",e[e.ForceQueued=2]="ForceQueued",e[e.Downloading=3]="Downloading",e[e.Downloaded=4]="Downloaded",e[e.DownloadFailed=5]="DownloadFailed"}(r||(r={}));const s=r},68373:(e,t,i)=>{"use strict";i.d(t,{$:()=>r,y:()=>MttrParseQueue});var r,s=i(80122),o=i(59855);!function(e){e.DEFAULT="DEFAULT",e.DEFAULT_FRUSTUM="DEFAULT_FRUSTUM",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH",e.STRICT_ERROR="STRICT_ERROR"}(r||(r={}));class MttrParseQueue extends s.Z{constructor(){super(...arguments),this.prioritizeBy=o.t.parsePriority,this.priorityCallback=(e,t)=>{switch(this.prioritizeBy=o.t.parsePriority,this.prioritizeBy){case r.STRICT_ERROR:return this.byRawError(e,t);case r.DEFAULT_FRUSTUM:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>e.__depth,e=>Number(e.__used),e=>e.__error,e=>e.__distanceFromCamera]);case r.FRUSTUM_ERROR_THRESH:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=o.t.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]);default:return this.defaultPriorityCallback(e,t)}}}byRawError(e,t){return e.__error>t.__error?-1:1}sortBySelectors(e,t,i){for(const r of i){const i=this.compareTile(e,t,r);if(null!==i)return i}return 0}compareTile(e,t,i){const r=i(e),s=i(t);return r===s?null:r>s?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}},59855:(e,t,i)=>{"use strict";i.d(t,{t:()=>h});var r=i(17597),s=i(20331),o=i(68373),a=i(60771),n=i(17916);const h={urlTemplateToken:"<file>",hideMenu:"1"!==(0,r.eY)("dmenu","0"),debug:"1"===(0,r.eY)("debugTiles","0"),displayBoxBounds:!1,initialMaxLOD:0,maxLOD:(0,r.eY)("maxLOD",n.V.Detail),loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,statsTiles:!0,statsTextures:!1,statsTextureStream:!1,errorTarget:Number((0,r.eY)("errorTarget",4)),disableTileUpdates:!1,errorMultiplierRaycastOcclusion:.1,errorMultiplierHiddenFloors:.01,disposeModel:!1,limitMemoryUsage:(0,a.tq)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,a.tq)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,tileAssetRequestPriority:s.RequestPriority.MEDIUM,downloadQueueConcurrency:8,parseQueueConcurrency:10,parsePriority:o.$.FRUSTUM_ERROR_THRESH,snappingMaxLOD:n.V.Standard}},27079:(e,t,i)=>{"use strict";i.d(t,{I6:()=>PriorityCriteria,at:()=>TilePrioritizer});var r,s=i(2212),o=i(52586),a=i(14844),n=i(32867),h=i(19674),c=i(34369),l=i(37381),u=i(17486),p=i(51263),d=i(57051),f=i(48715),g=i(41862),m=i(12216),y=i(60771),w=i(5087),S=i(82088);!function(e){e[e.None=0]="None",e[e.DirectionalFOV=1]="DirectionalFOV"}(r||(r={}));class PriorityCriteria{constructor(e,t,i,r){this.cameraRot=new s.Quaternion,this.sweep=e,this.cameraPosition=(new s.Vector3).copy(t),this.cameraDir=(new s.Vector3).copy(i),this.upcomingSweeps=r,this.zoomingActive=!1}}const b=(e,t,i=!1)=>{let r=0;if(e&&t)for(const s of t)i&&-1!==e.indexOf(s)||(e.push(s),r++);return r};class TilePrioritizer{constructor(e,t,i,r){this.panoQualityManager=e,this.tilingSettings=t,this.sweepData=i,this.raycaster=r,this.tempQueue=[],this.filterAndPrioritize=(e,t,i)=>{if(!this.priorityCriteria.sweep)return;const r=void 0!==this.priorityCriteria.upcomingSweeps&&null!==this.priorityCriteria.upcomingSweeps,s=this.tempQueue;s.length=0,this.queueTilesForPano(s,i,this.priorityCriteria.sweep,c.AB.BASE);const o=b(e,s,!0);this.currViewQueue[c.SL.BASE].value=o,this.fullPanoQueue[c.SL.BASE].value=o,r?this.queueForRestrictedSweeps(e,i):this.priorityCriteria.viewMode!==w.Ey.Panorama?this.queueForNonPanoViewmode(e,i):this.queueForPanoViewmode(e,t,i),this.tilingSettings.downloadFullPano&&this.queueFullPano(e,i)},this.queueRaycast=(()=>{const e=new s.Vector3;return(t,i)=>{if(this.priorityCriteria.sweep)if(this.priorityCriteria.hoveredSweep)this.queueTilesForPano(t,i,this.priorityCriteria.hoveredSweep,c.AB.BASE);else if(this.raycaster&&this.raycaster.hit){const r=e.copy(this.raycaster.hit.point).sub(this.priorityCriteria.sweep.position),s=this.getSinglePanoInDirection(r),o=this.sweepData.getSweep(s);o&&this.queueTilesForPano(t,i,o,c.AB.BASE)}}})(),this.queueRaycastIntersection=(e,t)=>{if(!this.raycaster||!this.raycaster.hit||!this.meshQuery)return;const i=(0,S.bG)(this.sweepData,!1,this.raycaster.hit.intersection,this.meshQuery),r=i.length>0?i[0].sweep:this.sweepData.getClosestSweep(this.raycaster.hit.point,!0);r&&this.queueTilesForPano(e,t,r,c.AB.BASE)},this.getSweepIdInLocalDirection=(()=>{const e=new s.Vector3;return t=>{const i=this.priorityCriteria.cameraRot,r=e.copy(t).applyQuaternion(i);return this.getSinglePanoInDirection(r)}})(),this.persistentStorage=new u.a,this.maxResolution=e.getNavPanoSize(),this.currViewQueue=C(),this.fullPanoQueue=C(),this.isMobileDevice=(0,y.tq)(),this.priorityCriteria=new PriorityCriteria(null,new s.Vector3(0,0,0),new s.Vector3(0,0,-1))}getQualityQueueSize(e,t){return e===g.v.CurrentView?this.currViewQueue[t].value:this.fullPanoQueue[t].value}makeQueueSubscription(e,t,i){return(e===g.v.CurrentView?this.currViewQueue[t]:this.fullPanoQueue[t]).onChanged(i)}updateCriteria(e,t,i,r){this.priorityCriteria.sweep=e,this.priorityCriteria.cameraPosition.copy(t),this.priorityCriteria.cameraDir.copy(i),this.priorityCriteria.cameraRot.copy(r)}setHoveredSweep(e){this.priorityCriteria.hoveredSweep=e}setUpcomingSweeps(e){this.priorityCriteria.upcomingSweeps=e}clearUpcomingSweeps(){this.priorityCriteria.upcomingSweeps=void 0}setDownloadFOV(e){TilePrioritizer.DIRECTIONAL_FOV=e}queueForRestrictedSweeps(e,t){if(!this.priorityCriteria.upcomingSweeps)return;let i=0;for(const r of this.priorityCriteria.upcomingSweeps)if(i++,this.queueTilesForPano(e,t,r,c.AB.BASE),i>=3)break;this.queueFOVStandardNarrow(e,t),this.queueFOVHighNarrow(e,t)}queueForPanoViewmode(e,t,i){this.queueRaycast(e,i),this.queueFOVStandardNarrow(e,i),this.queueScoredSweeps(e,t,i),this.queueFOVHighNarrow(e,i),this.isMobileDevice||this.queueWASD(e,t,i)}queueForNonPanoViewmode(e,t){this.queueRaycastIntersection(e,t)}queueFOVTiles(e,t,i,r){if(!this.priorityCriteria.sweep)return 0;const s=c.eE[t];return this.canDownloadSize(this.priorityCriteria.sweep,t)?this.queueTilesInDirectionForPano(e,r,this.priorityCriteria.sweep,s,this.priorityCriteria.cameraDir,i):0}queueScoredSweeps(e,t,i){if(this.priorityCriteria.sweep&&this.maxResolution<=2048){const r=this.persistentStorage.getArray("filterAndPrioritize:scoredSweeps");this.populateScoredSweeps(this.priorityCriteria.sweep,t,r,this.priorityCriteria.cameraDir,6),this.queueTilesForPanos(e,r,i,c.AB.BASE,4)}}queueFOVStandardNarrow(e,t){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;i.length=0;const r=this.queueFOVTiles(i,c.SL.STANDARD,TilePrioritizer.DIRECTIONAL_FOV,t);TilePrioritizer.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.cameraDir),b(e,i),this.currViewQueue[c.SL.STANDARD].value=r,this.fullPanoQueue[c.SL.STANDARD].value=r}queueFOVHighNarrow(e,t){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;i.length=0;const r=this.queueFOVTiles(i,c.SL.HIGH,TilePrioritizer.DIRECTIONAL_FOV,t),s=this.queueFOVTiles(i,c.SL.ULTRAHIGH,TilePrioritizer.DIRECTIONAL_FOV,t);TilePrioritizer.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.cameraDir),b(e,i),this.currViewQueue[c.SL.HIGH].value=r,this.currViewQueue[c.SL.ULTRAHIGH].value=s}queueFullPano(e,t){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;if(i.length=0,this.maxResolution<=c.AB.HIGH){if(this.canDownloadSize(this.priorityCriteria.sweep,c.SL.HIGH)){const e=this.queueTilesForPano(i,t,this.priorityCriteria.sweep,c.AB.HIGH);this.fullPanoQueue[c.SL.HIGH].value=e}}else if(this.canDownloadSize(this.priorityCriteria.sweep,c.SL.ULTRAHIGH)){const e=this.queueTilesForPano(i,t,this.priorityCriteria.sweep,c.AB.ULTRAHIGH);this.fullPanoQueue[c.SL.ULTRAHIGH].value=e}TilePrioritizer.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.cameraDir),b(e,i,!0)}queueWASD(e,t,i){const r=this.persistentStorage.getArray("filterAndPrioritize:neighbors")||[];if(r.length=0,!this.priorityCriteria.sweep)return;const s=[m.f.FORWARD,m.f.RIGHT,m.f.LEFT,m.f.BACK];for(const e of s){const i=this.getSweepIdInLocalDirection(e),s=t.get(i);s&&r.push(s)}this.queueTilesForPanos(e,r,i,c.AB.BASE)}canDownloadSize(e,t){const i=c.eE[t],r=this.panoQualityManager.getNavPanoSize()>=i||this.maxResolution>=i&&this.panoQualityManager.getZoomPanoSize()>=i,s=this.panoQualityManager.getTestResults(e.id,t);return r&&s===o.S.Untested&&this.panoQualityManager.testDownload(e,t,a.I_),s===o.S.Success&&r}populateScoredSweeps(e,t,i,r,o){(i=i||[]).length=0;const a=(new s.Vector3).copy(e.position),n=[p._k(),p.ff(e),p.jN(a,400),p.pI(a,r,.75)],h=[d.Dv(a,l.Xd.navigation.distanceFactor),d.o7(a,r,l.Xd.navigation.directionFactor)],c=this.sweepData.getSweepNeighbours(e),u=this.sweepData.sortByScore(n,h,c);for(let e=0;e<u.length&&e<o;e++){const t=u[e].sweep;i.push(t)}}queueTilesForPanos(e,t,i,r,s){let o=0;for(const a of t){if(o+=this.queueTilesForPano(e,i,a,r)>0?1:0,s&&o>=s)break}return o}queueTilesForPano(e,t,i,s){const o=this.persistentStorage.get("queueTilesForSweep:filterCriteria",(()=>({filter:r.None})));return this.filterAndQueueTileDownloadDescriptors(e,t,i,s,o)}queueTilesInDirectionForPano(e,t,i,o,n,h){const c=this.persistentStorage.get("queueTilesInDirectionForSweep:panoSpaceDir",(()=>new s.Vector3)),l=this.persistentStorage.get("queueTilesInDirectionForSweep:filterCriteria",(()=>({filter:r.DirectionalFOV,direction:new s.Vector3,fov:60})));return c.copy(n),a.ym(i.rotation,c),l.direction.copy(c),l.fov=h,this.filterAndQueueTileDownloadDescriptors(e,t,i,o,l)}filterAndQueueTileDownloadDescriptors(e,t,i,r,s){const o=this.persistentStorage.getArray("filterAndQueueTileDownloadDescriptors:descriptors"),a=t.getTileDownloadDescriptors(i,r);o.length=0,this.filterTileDownloadDescriptors(a,o,s);let n=0;for(const t of o)t&&(e.push(t),n++);return n}filterTileDownloadDescriptors(e,t,i){let s,o;switch(i.filter){case r.DirectionalFOV:for(s=0;s<e.length;s++)o=e[s],o&&a.eO(o.panoSize,o.tileSize,o.face,o.tileX,o.tileY,i.direction,i.fov)&&t.push(o);break;default:for(s=0;s<e.length;s++)o=e[s],t.push(o)}for(s=0;s<t.length;s++)o=t[s],o&&!this.canIncludeDescriptor(o)&&(t[s]=null)}canIncludeDescriptor(e){return e.status!==n.Z.Downloading&&e.status!==n.Z.Downloaded}static sortTiles(e,t,i){T.panoSpaceDir.copy(i),a.ym(t.rotation,T.panoSpaceDir),T.fovThresholdNarrow=h.tf(TilePrioritizer.DIRECTIONAL_FOV),e.sort(x)}static insertSortedPanoTile(e,t,i,r){T.panoSpaceDir.copy(r),a.ym(i.rotation,T.panoSpaceDir),T.fovThresholdNarrow=h.tf(TilePrioritizer.DIRECTIONAL_FOV);let s=-1;for(let i=0;i<e.length;i++){if(x(t,e[i])<=0){s=i;break}}if(-1===s)e[e.length]=t;else{for(let t=e.length;t>s;t--)e[t]=e[t-1];e[s]=t}}getSinglePanoInDirection(e){const t=this.priorityCriteria.sweep;if(!t)return"";const i=[p.ff(t),p._k(),p.pI(t.position,e)],r=[d.o7(t.position,e),d.TE(t.position)],s=t.neighbours.filter((e=>{const t=this.sweepData.getSweep(e);return i.every((e=>e(t)))})).map((e=>{const t=this.sweepData.getSweep(e);return{sweepId:e,score:r.reduce(((e,i)=>e+i(t)),0)}})),o=s.reduce(((e,t)=>e.score>t.score?e:t),s[0]);return o?o.sweepId:""}}TilePrioritizer.DIRECTIONAL_FOV=120;const T={panoSpaceDir:new s.Vector3,fovThresholdNarrow:-1},x=(e,t)=>{const i=T.panoSpaceDir,r=T.fovThresholdNarrow,s=Math.max(Math.min(i.dot(e.direction),1),-1),o=Math.max(Math.min(i.dot(t.direction),1),-1);return s>=r&&o<r?-1:s<r&&o>=r||e.panoSize>t.panoSize?1:t.panoSize>e.panoSize?-1:-(s-o)};function C(){return{[c.SL.BASE]:(0,f.Y)(0),[c.SL.STANDARD]:(0,f.Y)(0),[c.SL.HIGH]:(0,f.Y)(0),[c.SL.ULTRAHIGH]:(0,f.Y)(0)}}},15112:(e,t,i)=>{"use strict";i.d(t,{$:()=>Label3D,N:()=>k});var r=i(2212),s=i(7170),o=i(27408);window.THREE=Object.assign(Object.assign({},window.THREE),{BufferGeometry:r.BufferGeometry,Sphere:r.Sphere,Box3:r.Box3,Texture:r.Texture,Color:r.Color,BufferAttribute:r.BufferAttribute});var a=i(11385);var n,h=i(12216),c=i(27687),l=i(17597),u=i(88512);!function(e){e[e.NONE=0]="NONE",e[e.NUMERIC=1]="NUMERIC",e[e.ASCII=2]="ASCII"}(n||(n={}));const p={pages:[],chars:[],info:{face:"Loading",size:0,bold:0,italic:0,charset:[],unicode:1,stretchH:100,smooth:1,aa:1,padding:[0,0,0,0],spacing:[0,0],os2version:1},common:{lineHeight:0,base:0,scaleW:1,scaleH:1,pages:0,packed:0,alphaChnl:0,redChnl:0,greenChnl:0,blueChnl:0},kernings:[]};var d=i(66223),f=i(94085),g=i(23573);class BitmapFontAtlas extends g.T{constructor(e){super(),this.packer=e,this.fontData=p,this.textures=[]}update(e,t){this.fontData=t,this.textures.forEach((e=>e.dispose())),this.textures.length=0,this.textures.push(...e),this.commit()}addCharsIfNeeded(e){this.packer.addChars(e)}}const m=new u.Z("FontManager");class BitmapFontPackerStatic{constructor(){this.name="roboto-700-42-static",this._atlas=new BitmapFontAtlas(this),this.mWidth=0}async loadFont(){const[e,t]=await Promise.all([(0,d.p)(f),i.e(386).then(i.t.bind(i,60386,19))]),r=t.default;return this.estimateWidth(r),this._atlas.update([e],r),Promise.resolve({fontPath:this.name,font:this.name,packer:this})}addChars(e){m.debug(this.name,"does not support dynamic char adding")}measureText(e){if(this.mWidth)return e.length*this.mWidth}atlas(){return this._atlas}estimateWidth(e){const t=e.chars.find((e=>e.id==="m".charCodeAt(0)));t&&(this.mWidth=t.width)}}const y=(()=>{let e=null;return function(){return e||(e=Promise.all([i.e(764),i.e(422),i.e(143)]).then(i.bind(i,44422)).then((e=>e.load))),e}})();var w=i(35995);const S=function(){const e=document.createElement("a");return document.body.appendChild(e),e.style.display="none",(t,i)=>{const r=t.toDataURL();e.href=r,e.download=i,e.click()}}(),b=(e,t)=>{const i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),i.setAttribute("download",t),i.click()};var T=i(62330);const x=new u.Z("font-packer"),C={outlineOffset:Number((0,l.eY)("outlineOffset",.2)),save:"1"===(0,l.eY)("exportfont","0"),saveDefaultFont:"1"===(0,l.eY)("exportdefault","0"),verboseChars:!0,verboseFont:!0,perf:{log:!1,marks:{rebuild:"rebuild",kern:"kerning",metrics:"metrics",pack:"pack",texture:"texture",bmfont:"load-bmfont"}}};class BitmapFontPacker{constructor(e,t){this.needsRebuild=!1,this._atlas=new BitmapFontAtlas(this),this._loading=!1,this._loaded=!1,this._addedChars=[],this.charSet=new Set,this.kerningsMap={},this.measureMap={},this.metricsMap={},this.scale=1,this.throttledRebuild=(0,T.P)((()=>{setTimeout((()=>this.rebuild()),0)}),1500),this.options=e,t&&(this.font=t);try{this.canvas=document.createElement("canvas"),this.canvas.width=this.options.width,this.canvas.height=this.options.height;const e=this.canvas&&this.canvas.getContext("2d");if(!e)throw Error("Unable to create canvas context for font-packer");this.ctx=e,this.ctx.fillStyle="white",this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}catch(e){x.error("Failed to create canvas rendering context",e)}if(this.packer=new w.cC(this.options.width,this.options.height,2*this.options.texturePadding),this.options.defaultCharset){(function(e=!1){const t=new Set(Array.from("m0123456789_-+'\"` \t")),i=[];e&&i.push([32,127]);for(const e of i)for(let i=e[0];i<e[1];i++)t.add(String.fromCharCode(i));return t})(this.options.defaultCharset===n.ASCII||C.saveDefaultFont).forEach((e=>this.charSet.add(e)))}}get loaded(){return!this._loading&&this._loaded}async loadFont(){let e;C.perf.log&&performance.mark(C.perf.marks.bmfont);const t=`${this.options.fontFamily} for BitmapFontPacker`;if(!this.font){this._loading=!0,e=new FontFace(t,`url("${this.options.fontPath}") format("woff")`,{style:`${this.options.fontStyle}`,weight:`${this.options.fontWeight}`}),e.load();const i=e.loaded;document.fonts.add(e);const r=(await y())(this.options.fontPath),[s]=await Promise.all([r,i]);this.font=s}C.perf.log&&performance.measure(C.perf.marks.bmfont,C.perf.marks.bmfont),this.scale=this.options.fontSize/this.font.unitsPerEm;const i=`${this.options.fontWeight} ${this.options.fontSize}px "${t}"`;return this.ctx.font=i,C.verboseFont&&x.debug({contextFontFace:i,bmfont:this.font,charset:this.charSet}),this._loading=!1,this.fontFilename=`${this.options.fontFamily.toLowerCase()}-${this.options.fontWeight}-${this.options.fontSize}`+(this.options.outline?"-outline-"+this.options.outlineWidth:""),this.needsRebuild=!0,this.throttledRebuild(),{fontPath:this.options.fontPath,font:this.font,packer:this}}addChars(e){const t=this.charSet.size;return Array.from(e).forEach((e=>{this.charSet.has(e)||this._addedChars.push(e),this.charSet.add(e)})),t!==this.charSet.size&&(this.needsRebuild=!0,this.throttledRebuild()),this.needsRebuild}atlas(){return this._atlas}rebuild(){if(!this.font)return;if(this.loaded&&this._addedChars.length<1)return void(this.needsRebuild=!1);C.verboseChars&&(x.debug(`Added ${this._addedChars.length} glyphs: \n${this._addedChars}`),this._addedChars.length=0),performance.mark(C.perf.marks.rebuild),C.perf.log&&performance.mark(C.perf.marks.metrics);const e=this.getAllGlyphMetrics();C.perf.log&&performance.measure(C.perf.marks.metrics,C.perf.marks.metrics),C.perf.log&&performance.mark(C.perf.marks.pack);const t=this.pack(e);C.perf.log&&performance.measure(C.perf.marks.pack,C.perf.marks.pack),C.perf.log&&performance.mark(C.perf.marks.texture);const{chars:i,textures:r}=this.assembleTexture(t);C.perf.log&&performance.measure(C.perf.marks.texture,C.perf.marks.texture),C.perf.log&&performance.mark(C.perf.marks.kern);const s=this.getKerningPairs();C.perf.log&&performance.measure(C.perf.marks.kern,C.perf.marks.kern);const o=this.assembleFont(i,s,r);performance.measure(C.perf.marks.rebuild,C.perf.marks.rebuild),this._loaded=!0,this._atlas.update(r,o);const a=`Rebuilt atlas for ${this.charSet.size} chars with ${o.kernings.length} kerning pairs`;C.perf.log?(x.debug(a,performance.getEntriesByName(C.perf.marks.rebuild,"measure")[0],performance.getEntriesByType("measure").map((e=>({name:e.name,duration:e.duration}))),this.options),Object.values(C.perf.marks).forEach((e=>{performance.clearMarks(e),performance.clearMeasures(e)}))):(x.debug(a,performance.getEntriesByName(C.perf.marks.rebuild,"measure")[0]),performance.clearMarks(C.perf.marks.rebuild),performance.clearMeasures(C.perf.marks.rebuild))}pack(e){return this.packer.bins.length=0,this.packer.addArray(e),this.packer.bins.reverse()}assembleTexture(e){const t=[],i=e.map(((e,i)=>(this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.options.transparent&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),e.rects.forEach((e=>{const r=e.data.charData,s=e.x-r.xoffset,o=e.y+r.height+r.ymin-this.options.texturePadding;this.options.outline&&this.options.outlineWidth>0?function(e,t,i,r,s){const o=e.strokeStyle,a=e.fillStyle,n=e.lineJoin,h=e.miterLimit;e.lineJoin="miter",e.miterLimit=2,e.beginPath(),e.strokeStyle="black",e.lineWidth=s,e.strokeText(t,i,r),e.beginPath(),e.fillStyle="white",e.fillText(t,i,r),e.strokeStyle=o,e.fillStyle=a,e.lineJoin=n,e.miterLimit=h}(this.ctx,e.data.charData.char,s,o,this.options.outlineWidth):this.ctx.fillText(e.data.charData.char,s,o),r.x=e.x,r.y=e.y,r.page=i,t.push(e.data.charData)})),C.save&&S(this.ctx.canvas,`${this.fontFilename}_${i}.png`),this.makeCanvasTexture(i,!1))));return{chars:t,textures:i}}getKerningPairs(){const e=[],t=[...this.charSet.values()].map((e=>this.font.charToGlyphIndex(e))).filter((e=>e>0));for(const i of t)for(const r of t){const t=`${i},${r}`;let s=this.kerningsMap[t];if(!s){s={first:i,second:r,amount:this.font.getKerningValue(i,r)*this.scale},this.kerningsMap[t]=s}s&&0!==s.amount&&e.push(s)}return e}assembleFont(e,t,i){const r=this.font.tables.os2,s=this.font.tables.name.fullName,o=s[Object.getOwnPropertyNames(s)[0]],a={pages:i.map(((e,t)=>`${this.fontFilename}_${t}.png`)),chars:e,info:{face:o,size:this.options.fontSize,bold:0,italic:0,charset:[...this.charSet.values()],unicode:1,stretchH:100,smooth:1,aa:1,padding:[0,0,0,0],spacing:[this.options.texturePadding,this.options.texturePadding],os2version:r.version},common:{lineHeight:(r.sTypoAscender-r.sTypoDescender+r.sTypoLineGap)*this.scale,base:this.font.ascender*this.scale,scaleW:this.options.width,scaleH:this.options.height,pages:this.packer.bins.length,packed:0,alphaChnl:0,redChnl:0,greenChnl:0,blueChnl:0},kernings:t};return C.verboseFont&&x.debug({bmFontOutput:a,kerningPairCount:t.length}),C.save&&(b(JSON.stringify(a),`${this.fontFilename}.json`),b(JSON.stringify(this.options,void 0,2),`${this.fontFilename}-pack-options.json`)),a}getMetrics(e){const t=2*this.options.texturePadding,i=this.scale;let r,s,o,a,n,h;const c=this.font.charToGlyph(e),l=0!==c.index;if(l){let t=this.measureMap[e];t||(t=c.getMetrics(),this.measureMap[e]=t),r=(t.xMax-t.xMin)*i,s=(t.yMax-t.yMin)*i,o=t.xMin*i,a=t.yMin*i,n=t.yMax*i,h=c.advanceWidth*i}else{const t=this.measureChar(e);r=t.width,s=t.height,o=t.xMin,a=t.yMin,n=t.yMax,h=r}return{char:e,width:r+t,height:s+t,xmin:o,ymin:a,ymax:n,xadvance:h+(this.options.outline?this.options.outlineWidth*C.outlineOffset:0),supported:l}}measureText(e){if(!this.loaded)return;let t=0;for(const i of Array.from(e)){const{width:e}=this.measureChar(i);t+=e}return t}measureChar(e){let t=this.metricsMap[e];t||(t=this.ctx.measureText(e),this.metricsMap[e]=t);const i=t.actualBoundingBoxLeft+t.actualBoundingBoxRight;return{width:t.width||i,height:t.actualBoundingBoxAscent+t.actualBoundingBoxDescent,xMin:t.actualBoundingBoxLeft,xMax:t.actualBoundingBoxRight,yMin:-t.actualBoundingBoxDescent,yMax:t.actualBoundingBoxAscent}}getAllGlyphMetrics(){const e=[],t=this.font.ascender*this.scale,i=this.options.texturePadding;for(const r of this.charSet.values()){const s=this.getMetrics(r),o={data:{charData:{char:r,id:r.charCodeAt(0),width:s.width,height:s.height,xoffset:s.xmin-i,yoffset:t-s.ymax-i,xadvance:s.xadvance,chnl:15,ymin:s.ymin}},width:s.width,height:s.height};e.push(o)}return e}makeCanvasTexture(e,t){if(t){const e=new Uint8Array(this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data),t=new r.DataTexture(e,this.canvas.width,this.canvas.height,r.RGBAFormat);return t.flipY=!0,t}const i=new r.Texture(this.ctx.canvas);return i.name=`${this.ctx.font}_${e}`,i.format=r.RGBAFormat,i.needsUpdate=!0,i}}const F=new u.Z("FontManager"),D={fontPath:"fonts/roboto-700.woff",fontWeight:700,fontFamily:"Roboto",fontStyle:"normal",fontSize:60,width:2048,height:2048,transparent:!0,defaultCharset:n.ASCII,outline:!1,outlineWidth:4,texturePadding:6},M="1"===(0,l.eY)("staticfont","0");class FontManager{constructor(){this.defaultFontOptions=D,this.packerMap=new Map,this.optionsMap=new Map,this.parsedFontMap=new Map}static get instance(){return FontManager._instance||(FontManager._instance=new FontManager),FontManager._instance}getFontId(e=this.defaultFontOptions){const t=Object.assign(Object.assign({},this.defaultFontOptions),e),i=JSON.stringify(t);return this.optionsMap.set(i,t),i}getFont(e){let t=this.packerMap.get(e);if(!t&&M&&(t=new BitmapFontPackerStatic,t.loadFont(),this.packerMap.set(e,t)),!t){const i=this.optionsMap.get(e)||JSON.parse(e),r=this.parsedFontMap.get(i.fontPath);t=new BitmapFontPacker(i,r),this.packerMap.set(e,t),t.loadFont().then((t=>{F.debug("font loaded",e,t.fontPath),this.parsedFontMap.set(t.fontPath,t.font)}))}return t.atlas()}measureText(e,t){const i=this.packerMap.get(e);if(i)return i.measureText(t)}}var k,_=i(69626),v=i(37342);class Label3DMesh extends r.Mesh{}!function(e){e.WORLD="world",e.NDC="ndc"}(k||(k={}));class Label3D extends r.Object3D{constructor(e,t=FontManager.instance,o=k.WORLD){super(),this.config=e,this.fontManager=t,this.scaleType=o,this.update=()=>{const e=this.resolvedConfig;this.textGeometry.update(e),this.textGeometry.computeBoundingBox();const t=this.textGeometry.layout.lineHeight-this.textGeometry.layout.baseline;this.labelTextMesh.position.x=-.5*this.textGeometry.layout.width+t,this.labelTextMesh.position.y=-.5*this.textGeometry.layout.height+t,this.labelTextMesh.position.z=.25,this.unscaledWidth=this.textGeometry.layout.width+this.config.backgroundBorderWidth,this.unscaledHeight=this.textGeometry.layout.height+this.config.backgroundBorderHeight,(this.labelBackgroundMesh||this.config.backgroundAsCollider)&&this.labelBackgroundMesh.scale.set(this.unscaledWidth,this.unscaledHeight,.01),this.aspect=this.unscaledWidth/Math.max(this.unscaledHeight,.001),this.fontHeightToMeters=1/e.font.info.size,this.updateScale(),this._onGeomUpdate&&this._onGeomUpdate()};const n=void 0!==this.config.opacity?this.config.opacity:1;if(this.config.background||this.config.backgroundAsCollider){this.config.backgroundOpacity=void 0!==this.config.backgroundOpacity?this.config.backgroundOpacity:1,this.config.backgroundOpacity=this.config.background?this.config.backgroundOpacity:0;const t=new r.BoxGeometry(1,1,.01),i=new r.MeshBasicMaterial({color:e.backgroundColor,transparent:!0,depthTest:this.config.backgroundOpacity>0&&!e.disableDepth,depthWrite:this.config.backgroundOpacity>0&&!e.disableDepth,opacity:this.config.backgroundOpacity,stencilRef:1,stencilFail:r.KeepStencilOp,stencilZFail:r.KeepStencilOp,stencilZPass:r.ReplaceStencilOp,stencilFunc:r.AlwaysStencilFunc,stencilWrite:!0});this.labelBackgroundMesh=new this.config.backgroundColliderType(t,i),this.labelBackgroundMesh.position.z=-.25,this.labelBackgroundMesh.name="Label Background",this.collider=this.labelBackgroundMesh,this.add(this.labelBackgroundMesh)}const c={outline:this.config.outline,outlineWidth:this.config.outlineWidth},l={uniforms:{map:{type:"t",value:(u=Object.assign(Object.assign({},c),{color:e.color,opacity:n})).map},color:{type:"c",value:new r.Color(u.color)},opacity:{type:"f",value:u.opacity}},vertexShader:i(60948),fragmentShader:i(45576)};var u;const p=new r.RawShaderMaterial({uniforms:l.uniforms,fragmentShader:l.fragmentShader,vertexShader:l.vertexShader,side:r.DoubleSide,transparent:!0,depthTest:!1,depthWrite:!1,opacity:n});p.name="Label Text",this.fontId=this.fontManager.getFontId(c);const d=this.fontManager.getFont(this.fontId);p.uniforms.map.value=d.textures[0],d.onChanged((()=>{p.uniforms.map.value=d.textures[0],this.update()}));const f=this.resolvedConfig,g=f.font;this.textGeometry=a(f),this.labelTextMesh=new Label3DMesh(this.textGeometry,p),this.labelTextMesh.name="Label Text",this.labelTextMesh.renderOrder=10;const m=(new r.Quaternion).setFromAxisAngle(h.f.FORWARD,(0,s.Id)(180)),y=(new r.Quaternion).setFromAxisAngle(h.f.UP,(0,s.Id)(180));this.labelTextMesh.quaternion.multiply(m).multiply(y),this.add(this.labelTextMesh),this.name="Label Container",this.fontHeightToMeters=1/g.info.size,this.scaleFactor=e.scale||this.fontHeightToMeters,this.update()}get resolvedConfig(){let e;if(void 0!==this.config.wordWrapWidth){const t=this.fontManager.measureText(this.fontId,this.config.text);void 0!==t&&t>this.config.wordWrapWidth&&(e=this.config.wordWrapWidth)}const t=this.fontManager.getFont(this.fontId);return Object.assign(Object.assign({},this.config),{font:t.fontData,texture:t.textures[0],width:e})}onGeomUpdate(e){this._onGeomUpdate=e}updateScale(){const e=this.config.scale*this.fontHeightToMeters;this.scale.set(e,e,e)}get text(){return this.config.text}set text(e){e!==this.name&&(this.config.text=e,this.name=e,this.fontManager.getFont(this.fontId).addCharsIfNeeded(e),this.update())}get mesh(){return this.labelTextMesh}get scaleFactor(){return this.config.scale}set scaleFactor(e){this.scaleFactor!==e&&(this.config.scale=e,this.updateScale())}get opacity(){return void 0!==this.config.opacity?this.config.opacity:1}set opacity(e){if(e!==this.config.opacity){this.config.opacity=e;const t=e>0&&!this.config.disableDepth;if(this.config.background){const i=this.labelBackgroundMesh.material;i.opacity=Math.min(this.config.backgroundOpacity||1,e),i.depthWrite=e>v.iV.DEPTH_WRITE_THRESHOD,i.depthTest=t}const i=this.labelTextMesh.material;i.uniforms.opacity.value=e,i.depthTest=t,this.visible=e>0}}setColorHex(e){const t=this.labelTextMesh.material.uniforms.color;t.value.getHex()!==e&&t.value.setHex(e)}setRenderLayer(e){this.labelTextMesh.layers.mask=e.mask,this.labelBackgroundMesh&&(this.labelBackgroundMesh.layers.mask=e.mask)}setRenderOrder(e){this.renderOrder=e,this.labelTextMesh.renderOrder=e,this.labelBackgroundMesh&&(this.labelBackgroundMesh.renderOrder=e)}setPosition(e,t=(e=>e)){this.position.copy(t(e))}setOrientation(e,t=0){this.quaternion.copy(e),0!==t&&this.rotateZ(-t*s.Ue)}scaleBillboard(e,t,i,r,s,a,n=A.SCALE_DEFAULT){if(0!==i.elements[15])this.scaleFactor=.2*n*r*(A.ORTHO_IDEAL_HEIGHT/s);else{const h=(0,c.D_)(this.position,e,t,i.asThreeMatrix4()),l=Math.abs(h.x);if(l<1){const t=(0,_.mY)(i,e,this.position,s,n),h=((0,o.uZ)(a,1,2.5)+r)*A.SCALE_ASPECT,c=1+A.SCALE_NDC-l*A.SCALE_NDC-h,u=Math.max(Math.min(1/t*c,3),.001);this.scaleType===k.NDC?this.scaleFactor=u:this.scaleFactor=Math.min(u*A.NDC_MULT,n*A.SCALE_WORLD)}else this.scaleFactor=.001}this.updateScale()}}const A={SCALE_DEFAULT:.1,SCALE_WORLD:Number((0,l.eY)("scale_world",4)),SCALE_NDC:.5,SCALE_ASPECT:.035,DEPTH_WRITE_THRESHOD:.15,ORTHO_IDEAL_HEIGHT:1500,NDC_MULT:1.15}},42530:(e,t,i)=>{"use strict";i.d(t,{u:()=>Label3DFactory});var r=i(15112),s=i(2212);class Label3DFactory{constructor(e){this.currentTextConfig=Label3DFactory.defaultTextConfig,e?this.updateTextStyle(e):this.updateTextStyle(Label3DFactory.defaultTextConfig)}updateTextStyle(e){this.currentTextConfig=Object.assign(Object.assign({},this.currentTextConfig),e)}createLabel(e={text:""}){return new r.$(Object.assign(Object.assign({},this.currentTextConfig),e))}static makeConfig(e){return Object.assign(Object.assign({},this.defaultTextConfig),e)}}Label3DFactory.defaultTextConfig={text:"",align:"center",wordWrapWidth:void 0,color:"black",backgroundColor:"white",backgroundBorderWidth:50,backgroundBorderHeight:30,background:!0,backgroundAsCollider:!0,backgroundColliderType:s.Mesh,scale:1,outline:!1,outlineWidth:4}},45576:e=>{e.exports="precision highp float;precision highp int;uniform sampler2D map;uniform vec3 color;uniform float opacity;varying vec2 vUv;void main(){vec4 sample=texture2D(map,vUv).rgba;gl_FragColor=vec4(sample.rgb*color.rgb,clamp(sample.a*opacity,0.,1.));}"},60948:e=>{e.exports="precision highp float;precision highp int;attribute vec2 uv;attribute vec4 position;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*position;}"}}]);