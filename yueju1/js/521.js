(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[521],{80122:(e,t,r)=>{"use strict";r.d(t,{Z:()=>PriorityQueue});class PriorityQueue{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((r,a)=>{const i=this.items,l=this.callbacks;i.push(e),l.set(e,((...e)=>t(...e).then(r).catch(a))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,r=this.callbacks,a=t.indexOf(e);-1!==a&&(t.splice(a,1),r.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,r=this.maxJobs;let a=this.currJobs;for(;r>a&&e.length>0;){a++;const r=e.pop(),i=t.get(r);t.delete(r),i(r).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=a}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}},61501:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>u});var a=r(66219),i=r(96909),l=r(2388),n=r(41659),s=r(86980),o=r(6559);const u=async function(e){const t=await e.getModuleBySymbol(i.y.SETTINGS),r=t.addPanel(a.s.TITLE,a.s.HOTKEYS,{width:350});await t.loadPromise.then((()=>{const a="meshtextures";[{panel:r,header:a,setting:"disableTextureStreamBelowLod",initialValue:()=>l.ZP.disableTextureStreamBelowLod,onChange:e=>{l.ZP.disableTextureStreamBelowLod=e,(0,o.qT)().limitStreamingBelow(l.ZP.disableTextureStreamBelowLod)},urlParam:!0,rangePrecision:0,range:[0,10]},{panel:r,header:a,setting:"textureStreamPause",initialValue:()=>l.ZP.debugPauseTexStream,onChange:e=>{l.ZP.debugPauseTexStream=e},urlParam:!0},{panel:r,header:a,setting:"textureStreamRaycastHits",initialValue:()=>l.ZP.debugLOD,onChange:e=>{l.ZP.debugLOD=e,e||(0,s.d)()},urlParam:!0},{panel:r,header:a,setting:"debugRTTQuality",initialValue:()=>l.ZP.debugRttQuality,onChange:t=>{l.ZP.debugRttQuality=t,t||e.commandBinder.issueCommand(new n.u({color:null},{style:n.u.selectBy.all}))},urlParam:!0},{panel:r,header:a,setting:"debugRTTScores",initialValue:()=>l.ZP.debugRttScores,onChange:t=>{l.ZP.debugRttScores=t,t||e.commandBinder.issueCommand(new n.u({color:null},{style:n.u.selectBy.all}))},urlParam:!0}].forEach((e=>t.registerMenuEntry(e)))}))}},45364:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>_,tiledMeshDebugMenu:()=>M});var a=r(88512),i=r(96909),l=r(10757),n=r(84933),s=r(55356),o=r(68373),u=r(66219),d=r(59855),c=r(2388),g=r(84303),h=r(2212),m=r(6559),p=r(44283);function y(e,t=16){let r;const a=(0,p.k1)((()=>r=window.setInterval((()=>e()),t)),(()=>{r&&clearInterval(r)}));return a.cancel(),a}const b=new a.Z("tiled-mesh");let T,x=null;function S(e,t,r){x||(x=document.createElement("div"),x.style.color="#FFFFFF",x.style.fontFamily="Roboto",x.style.fontWeight="300",x.style.fontSize="12px",x.style.position="absolute",x.style.top="50px",x.style.width="500px",x.style.pointerEvents="none",x.style.whiteSpace="pre",x.style.zIndex="99999",x.style.textShadow="0 0 1px black, 0 0 1px black, 0 0 1px black, 0 0 1px black",document.body.appendChild(x));let a=d.t.statsTiles?function(e,t){const r=e.tilesRenderer,a=r.visibleTiles,i={};a.forEach((e=>{var t;const r=`lod${null===(t=e.extras)||void 0===t?void 0:t.level}`,a=i[r]||0;i[r]=a+1}));const l=t.threeRenderer.info,{stats:n,downloadQueue:s,parseQueue:o,lruCache:u}=r,{active:d,downloading:c,inFrustum:g,parsing:h,used:m,visible:p}=n;return`\nthree:\n    drawCalls: ${l.render.calls}\n    geometries: ${l.memory.geometries}\n    textures: ${l.memory.textures}\n    triangles: ${l.render.triangles}\n    memory allocated (megs): ${Math.floor(t.estimatedGPUMemoryAllocated()/2**20)}\ntiles:\n    tiles in frustum: ${g}\n    visible: ${p}\n      lod0 tiles: ${i.lod0||0}\n      lod1 tiles: ${i.lod1||0}\n      lod2 tiles: ${i.lod2||0}\n      lod3 tiles: ${i.lod3||0}\n    downloading gltf: ${c}\n    parsing gltf: ${h}\n    active: ${d}\n    used: ${m}\n    queues:\n      download: ${s.currJobs} running, ${s.items.length} waiting\n      parse: ${o.currJobs} running, ${o.items.length} waiting\n    lruCache: ${u.itemSet.size}\n`}(e,r):"";a+=d.t.statsTextureStream?function(e){const t="downloaded:\n"+Object.keys(e.totalTextures).map((t=>`    ${t}: ${e.totalTextures[t]} `)).join("\n")+"\n";return`textureStreaming:\n    downloadingTiles: ${e.downloadingTiles} / ${e.totalTiles}\n    downloadingTextures: ${e.loadingTextures}\n`+t}(t):"",a+=d.t.statsTextures?function(e){if(T)return T;const t=e.tilesRenderer;if(!t)return"";const r={};function a(e,t,r){const a=r.extras.maxTextureSize||0,i=e[t]||new Map;e[t]=i,i.set(a,(i.get(a)||new Set).add(r.extras.textureName))}return t.traverse((e=>{if(e.extras&&void 0!==e.extras.maxTextureSize&&void 0!==e.extras.level){const t=`lod${e.extras.level}`;a(r,t,e)}return!1}),(()=>!1)),T="texturesPerLod:\n"+Object.keys(r).map((e=>`    ${e}:${[...r[e].entries()].map((([e,t])=>` ${e}px: ${t.size}`))} `)).join("\n"),T}(e):"",x.textContent=a}async function M(e){if(!d.t.debug)return;const t=await e.getModuleBySymbol(i.y.SETTINGS),r=await e.getModuleBySymbol(i.y.INPUT),a=await e.getModuleBySymbol(i.y.WEBGL_RENDERER),g=a.getScene(),h=await e.getModuleBySymbol(i.y.MODEL_MESH),p=h.modelTextureLoader,T=h.modelMesh.tileLoader,x=t.tryGetProperty(c.iT,!1);x&&d.t.statsTiles&&setInterval((()=>S(T,p,a)),150);const M=t.addPanel(u.s.TITLE,u.s.HOTKEYS,{width:350}),_={viz:"visualize",stats:"stats",tile:"tileset",log:"log"},v=function(e,t,r,a,i){const l=C(r,i,((e,t)=>e.setWireframe(t))),o=function(e,t){const r={scale:1},a=(t,a)=>{if(!t)return;const i=e.container.tilesByChunkId.get(t.id),l=(null==i?void 0:i.__error)||1e-4,n=t.lod!==d.t.maxLOD&&l>d.t.errorTarget?1:.5,s=Math.max(0,Math.min(1,1-r.scale/l)),o=a?P(t.lod,s,n):null;t.setColorOverlay(o)},i=C(e,t,a),l=y((()=>i.colorize(e.container.chunks)));return{toggle:e=>{e?l.renew():l.cancel(),i.toggle(e)},colorize:i.colorize,subscription:l,config:r}}(r,i),u=C(r,i,((e,t)=>{e.setColorOverlay(t?P(e.lod,1,.5):null)})),c=C(r,i,((e,t)=>{e.setColorOverlay(t?(0,s.G1)(.5,e.id||0):null)})),g=C(r,i,((e,t)=>{var a;const i=r.container.tilesByChunkId.get(e.id);e.setColorOverlay(t?(0,s.G1)(.5,(0,n.un)((null===(a=null==i?void 0:i.content)||void 0===a?void 0:a.uri)||"missing")||0):null)})),h=C(r,i,((e,t)=>{e.setColorOverlay(t?(0,s.G1)(.5,(e.meshGroup<<16)+e.meshSubgroup||0):null)})),p=C(r,i,((e,t)=>{e.setColorOverlay(t?(0,s.G1)(.5,e.meshSubgroup||0):null)})),T=C(r,i,((e,t)=>{e.setColorOverlay(t?(0,s.G1)(.5,e.meshGroup||0):null)})),x=C(r,i,((e,t)=>{e.setColorOverlay(t?(0,s.G1)(.5,(0,n.un)(e.textureName)||0):null)})),S=C(r,i,((e,t)=>{const a=r.container.tilesByChunkId.get(e.id);e.setColorOverlay(t?(0,s.G1)(.5,(null==a?void 0:a.geometricError)||0):null)})),M=a.slots,_=(0,m.qT)(),v=C(r,i,((e,t)=>{const r=M.find((t=>t.textureName===e.textureName));if(r){const a=r.loading?1:r.quality>_.min(e.lod)?.7:.3,i=_.maxTexelSize/_.get(r.quality).texelSize;e.setColorOverlay(t?P(e.lod,i,a):null)}})),R=y((()=>v.colorize(r.container.chunks)));let f="none";const w={none:void 0,byError:o,byGeometricError:S,byTile:g,bySubgroup:p,byMeshgroup:T,bySubAndMeshgroup:h,byTexture:x,byStreamedTextures:{subscription:R,toggle:e=>{e?R.renew():R.cancel(),e&&b.info("colorize=byStreamedTextures solid color: loading, dark color: streamed, light color: basis"),v.toggle(e)}},byChunk:c,byLod:u};return[{panel:e,header:t.viz,setting:"disableTileUpdates",initialValue:()=>d.t.disableTileUpdates,onChange:e=>{d.t.disableTileUpdates=e},urlParam:!0},{panel:e,header:t.viz,setting:"wireframe",initialValue:()=>!1,onChange:l.toggle,urlParam:!0},{panel:e,header:t.viz,setting:"colorize",initialValue:()=>"none",onChange:e=>{var t,r;null===(t=w[f])||void 0===t||t.toggle(!1),null===(r=w[e])||void 0===r||r.toggle(!0),f=e},options:Object.keys(w),urlParam:!0},{panel:e,header:t.viz,setting:"colorizeByErrorScale",initialValue:()=>1,onChange:e=>{o.config.scale=e},range:[0,6],rangePrecision:3,urlParam:!0}]}(M,_,T,p,e),R=[{panel:M,header:_.stats,setting:"tileStatsOverlay",initialValue:()=>d.t.statsTiles,onChange:e=>{d.t.statsTiles=e},urlParam:!0},{panel:M,header:_.stats,setting:"textureStatsOverlay",initialValue:()=>d.t.statsTextures,onChange:e=>{d.t.statsTextures=e},urlParam:!0},{panel:M,header:_.stats,setting:"textureStreamingOverlay",initialValue:()=>d.t.statsTextureStream,onChange:e=>{d.t.statsTextureStream=e},urlParam:!0}],f=[{panel:M,header:_.log,buttonName:"Log: App State",callback:()=>{b.warn(h),b.warn(r),b.warn(g),b.warn(t)}}];x&&(d.t.hideMenu||await(0,l.gw)(1e3).then((()=>{t.getSettingsGui().loadGuiPackage().then((()=>{t.getSettingsGui().toggle(t.getMainPanelId()),t.getSettingsGui().toggle(t.getMainPanelId())}))})),await(0,l.gw)(16),v.forEach((e=>t.registerMenuEntry(e))),await(0,l.gw)(16),function(e,t){return[{panel:e,header:t.tile,setting:"maxLOD",initialValue:()=>d.t.maxLOD,onChange:e=>{d.t.maxLOD=e},range:[0,3],rangePrecision:0,urlParam:!0},{panel:e,header:t.tile,setting:"errorTarget",initialValue:()=>d.t.errorTarget,onChange:e=>{d.t.errorTarget=e},range:[0,20],rangePrecision:1,urlParam:!0},{panel:e,header:t.tile,setting:"displayActiveTiles",initialValue:()=>d.t.displayActiveTiles,onChange:e=>{d.t.displayActiveTiles=e},urlParam:!0},{panel:e,header:t.tile,setting:"loadSiblings",initialValue:()=>d.t.loadSiblings,onChange:e=>{d.t.loadSiblings=e},urlParam:!0},{panel:e,header:t.tile,setting:"autoDisableRendererCulling",initialValue:()=>d.t.autoDisableRendererCulling,onChange:e=>{d.t.autoDisableRendererCulling=e},urlParam:!0},{panel:e,header:t.tile,setting:"stopAtEmptyTiles",initialValue:()=>d.t.stopAtEmptyTiles,onChange:e=>{d.t.stopAtEmptyTiles=e},urlParam:!0},{panel:e,header:t.tile,setting:"disableTileUpdates",initialValue:()=>d.t.disableTileUpdates,onChange:e=>{d.t.disableTileUpdates=e},urlParam:!0},{panel:e,header:t.tile,setting:"disposeModel",initialValue:()=>d.t.disposeModel,onChange:e=>{d.t.disposeModel=e},urlParam:!0},{panel:e,header:t.tile,setting:"limitMemoryUsage",initialValue:()=>d.t.limitMemoryUsage,onChange:e=>{d.t.limitMemoryUsage=e},urlParam:!0},{panel:e,header:t.tile,setting:"allocatedMegsBeforeLimitingLod",initialValue:()=>d.t.allocatedMegsBeforeLimitingLod,onChange:e=>{d.t.allocatedMegsBeforeLimitingLod=e},urlParam:!0,range:[100,1e3]},{panel:e,header:t.tile,setting:"lruMinExtraTiles",initialValue:()=>d.t.lruMinExtraTiles,onChange:e=>{d.t.lruMinExtraTiles=e},urlParam:!0,range:[0,2e3]},{panel:e,header:t.tile,setting:"lruMaxTiles",initialValue:()=>d.t.lruMaxTiles,onChange:e=>{d.t.lruMaxTiles=e},urlParam:!0,range:[0,2e3]},{panel:e,header:t.tile,setting:"lruUnloadPercent",initialValue:()=>d.t.lruUnloadPercent,onChange:e=>{d.t.lruUnloadPercent=e},urlParam:!0,range:[0,1]},{panel:e,header:"Priority",setting:"parsePriorityFunction",initialValue:()=>d.t.parsePriority,onChange:e=>{b.warn("parse mode:",e),d.t.parsePriority=e},options:Object.keys(o.$),urlParam:!0},{panel:e,header:"Priority",setting:"errorMultiplierRaycastOcclusion",initialValue:()=>d.t.errorMultiplierRaycastOcclusion,onChange:e=>{d.t.errorMultiplierRaycastOcclusion=e},urlParam:!0,range:[.001,1],rangePrecision:2},{panel:e,header:"Priority",setting:"errorMultiplierHiddenFloors",initialValue:()=>d.t.errorMultiplierHiddenFloors,onChange:e=>{d.t.errorMultiplierHiddenFloors=e},urlParam:!0,range:[.001,1],rangePrecision:2}]}(M,_).forEach((e=>t.registerMenuEntry(e))),R.forEach((e=>t.registerMenuEntry(e))),f.forEach((e=>t.registerMenuButton(e))))}function C(e,t,r){let a=!1;const i=e=>{t.after(g.A.End).then((()=>{e.forEach((e=>{e&&r(e,a)}))}))},l=e.notifyOnChunksLoaded(i);l.cancel();return{toggle:t=>{t?l.renew():l.cancel(),t!==a&&(a=t,i([...e.container.chunks]))},colorize:i,subscription:l}}function P(e,t,r){const a=0===e||3===e?1:0,i=1===e||3===e?1:0,l=2===e||3===e?1:0;return new h.Vector4(a*t,i*t,l*t,r)}const _=M},66219:(e,t,r)=>{"use strict";r.d(t,{s:()=>a});const a={TITLE:"streamed-mesh (T)",HOTKEYS:[r(81507).R.T]}},41659:(e,t,r)=>{"use strict";r.d(t,{u:()=>SetMeshOverlayCommand});var a,i,l=r(17386);!function(e){e.all="all",e.byMeshGroup="byMeshGroup",e.byMeshSubGroup="byMeshSubGroup"}(a||(a={})),function(e){e.explicit="explicit",e.random="random"}(i||(i={}));class SetMeshOverlayCommand extends l.m{constructor(e,t){super(),this.id="SET_MESH_OVERLAY_COLOR",this.payload={selectBy:(null==t?void 0:t.style)||a.all,colorStyle:(null==e?void 0:e.style)||i.explicit,color:(null==e?void 0:e.color)||null,alpha:(null==e?void 0:e.alpha)||.5,index:null==t?void 0:t.index}}}SetMeshOverlayCommand.selectBy=a,SetMeshOverlayCommand.colorBy=i,SetMeshOverlayCommand.COLOR_DIM={x:0,y:0,z:0,w:.3}},68373:(e,t,r)=>{"use strict";r.d(t,{$:()=>a,y:()=>MttrParseQueue});var a,i=r(80122),l=r(59855);!function(e){e.DEFAULT="DEFAULT",e.DEFAULT_FRUSTUM="DEFAULT_FRUSTUM",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH",e.STRICT_ERROR="STRICT_ERROR"}(a||(a={}));class MttrParseQueue extends i.Z{constructor(){super(...arguments),this.prioritizeBy=l.t.parsePriority,this.priorityCallback=(e,t)=>{switch(this.prioritizeBy=l.t.parsePriority,this.prioritizeBy){case a.STRICT_ERROR:return this.byRawError(e,t);case a.DEFAULT_FRUSTUM:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>e.__depth,e=>Number(e.__used),e=>e.__error,e=>e.__distanceFromCamera]);case a.FRUSTUM_ERROR_THRESH:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=l.t.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]);default:return this.defaultPriorityCallback(e,t)}}}byRawError(e,t){return e.__error>t.__error?-1:1}sortBySelectors(e,t,r){for(const a of r){const r=this.compareTile(e,t,a);if(null!==r)return r}return 0}compareTile(e,t,r){const a=r(e),i=r(t);return a===i?null:a>i?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}},59855:(e,t,r)=>{"use strict";r.d(t,{t:()=>o});var a=r(17597),i=r(20331),l=r(68373),n=r(60771),s=r(17916);const o={urlTemplateToken:"<file>",hideMenu:"1"!==(0,a.eY)("dmenu","0"),debug:"1"===(0,a.eY)("debugTiles","0"),displayBoxBounds:!1,initialMaxLOD:0,maxLOD:(0,a.eY)("maxLOD",s.V.Detail),loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,statsTiles:!0,statsTextures:!1,statsTextureStream:!1,errorTarget:Number((0,a.eY)("errorTarget",4)),disableTileUpdates:!1,errorMultiplierRaycastOcclusion:.1,errorMultiplierHiddenFloors:.01,disposeModel:!1,limitMemoryUsage:(0,n.tq)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,n.tq)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,tileAssetRequestPriority:i.RequestPriority.MEDIUM,downloadQueueConcurrency:8,parseQueueConcurrency:10,parsePriority:l.$.FRUSTUM_ERROR_THRESH,snappingMaxLOD:s.V.Standard}},86980:(e,t,r)=>{"use strict";r.d(t,{e:()=>o,d:()=>u});var a=r(2212);const i=r(2388).ZP.sightingMaxAge,l=new a.Color;let n,s=-1;const o=(e,t)=>{n||(n=new a.InstancedMesh(new a.SphereBufferGeometry(.005,8,4),new a.MeshBasicMaterial,i),d(n));const r=new a.Matrix4;return({point:a,distance:o})=>{r.makeScale(o,o,o).setPosition(a),n.setMatrixAt(++s%i,r),n.instanceMatrix.needsUpdate=!0;for(let t=i;t--;)n.setColorAt((s-t+i)%i,l.set(e).multiplyScalar(1-t/i));n.instanceColor&&(n.instanceColor.needsUpdate=!0),n.parent||t.scene.add(n)}},u=()=>{var e;n&&(null===(e=n.parent)||void 0===e||e.remove(n),d(n))};function d(e){const t=(new a.Matrix4).makeScale(0,0,0);for(let r=0;r<i;r++)e.setMatrixAt(r,t)}}}]);